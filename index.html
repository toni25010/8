<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; --buy: #238636; --sell: #f85149; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
        h2 { text-align: center; font-size: clamp(1.1rem, 4vw, 1.6rem); margin: 0 0 12px 0; }
        .grid { display: grid; grid-template-columns: 2.2fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        #chart { height: 400px; width: 100%; position: relative; background: var(--card); border-radius: 12px; overflow: hidden; }
        
        .ticker-wrap { display: flex; justify-content: space-between; background: #0d1117; padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ticker-val { font-size: 24px; font-weight: 700; font-family: 'Courier New'; }
        .ticker-label { font-size: 10px; color: #8b949e; margin-bottom: 2px; }
        
        .signal-display { text-align: center; padding: 12px; border-radius: 16px; border: 2px solid var(--border); margin-bottom: 8px; transition: 0.3s; position: relative; }
        .signal-display.buy { border-color: var(--buy); color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .signal-display.sell { border-color: var(--sell); color: var(--sell); background: rgba(248, 81, 73, 0.1); }
        .signal-display.hold { border-color: #d29922; color: #d29922; background: rgba(210, 153, 34, 0.1); }
        
        .update-badge { position: absolute; top: 8px; right: 8px; font-size: 9px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px; display: none; }

        .trade-plan-box { margin-top: 10px; background: #0d1117; border-radius: 12px; padding: 10px; border: 1px solid var(--border); display: none; }
        .plan-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .plan-row:last-child { border-bottom: none; }
        
        .news-box { margin-top: 12px; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .news-item { padding: 8px; border-left: 4px solid #3b82f6; margin-bottom: 6px; background: rgba(255,255,255,0.02); }
        .news-time { color: #60a5fa; font-size: 10px; font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; justify-content: space-between; }
        .news-sentiment { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 600; }
        .sentiment-bullish { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .sentiment-bearish { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .sentiment-neutral { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .impact-high { color: #f85149; font-weight: bold; }
        .impact-medium { color: #d29922; }
        .impact-low { color: #3b82f6; }
        
        .news-filter { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .filter-btn { background: #21262d; color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 12px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-item { background: #0d1117; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between;}
        
        button { background: var(--accent); color: white; border: none; padding: 12px 16px; cursor: pointer; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.small { background: #21262d; width: auto; padding: 8px 12px; margin-top: 0; font-size: 12px; }
        
        input, select { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 10px; margin-top: 6px; font-size: 13px; }
        
        .analysis-summary { margin-top: 12px; background: #0d1117; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .summary-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #161b22; cursor: pointer; font-size: 12px; font-weight: 600; color: #8b949e; }
        #ai_desc { padding: 10px; font-size: 12px; line-height: 1.5; color: var(--text); border-top: 1px solid var(--border); white-space: pre-wrap; }

        .ticker-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .ticker-input { flex: 1; }
        .ticker-btn { background: #21262d; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }

        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h2>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>

    <div class="grid">
        <!-- –õ–ï–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê (–≥—Ä–∞—Ñ–∏–∫ + –Ω–æ–≤–æ—Å—Ç–∏) -->
        <div class="card">
            <div class="ticker-controls">
                <input type="text" id="tickerInput" class="ticker-input" placeholder="–ö–æ–¥ (SiH6)" value="SiH6">
                <button class="ticker-btn" onclick="setTicker('SiH6')">Si</button>
                <button class="ticker-btn" onclick="setTicker('SRH6')">SBER</button>
                <button class="ticker-btn" onclick="setTicker('BRH6')">BR</button>
                <button class="ticker-btn" onclick="applyTicker()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>

            <div id="chart"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: #8b949e;">
                <span id="contractName">–ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span id="tickerDisplay">SiH6</span></span>
                <span id="lastTradeTime">--</span>
            </div>

            <div class="news-box" id="newsBox">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #3b82f6;">–ù–æ–≤–æ—Å—Ç–∏</span>
                    <span id="newsCount" style="color:#8b949e; font-size: 11px;">0</span>
                </div>
                <div class="news-filter">
                    <button class="filter-btn active" onclick="filterNews('all', event)">–í—Å–µ</button>
                    <button class="filter-btn" onclick="filterNews('bullish', event)">–ë—ã—á—å–∏</button>
                    <button class="filter-btn" onclick="filterNews('bearish', event)">–ú–µ–¥–≤–µ–∂—å–∏</button>
                    <button class="filter-btn" onclick="fetchNews()">üîÑ</button>
                </div>
                <div id="newsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê (—Å–∏–≥–Ω–∞–ª—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) -->
        <div class="card">
            <div class="ticker-wrap">
                <div>
                    <div class="ticker-label">–ü–û–°–õ–ï–î–ù–Ø–Ø –¶–ï–ù–ê</div>
                    <div class="ticker-val" id="currentPrice">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="ticker-label">–ò–ó–ú–ï–ù–ï–ù–ò–ï</div>
                    <div class="ticker-val" id="changePercent">--</div>
                </div>
            </div>

            <div id="signal_ui" class="signal-display hold">
                <div id="updateBadge" class="update-badge">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>
                <div style="font-size: 10px; opacity: 0.7;">–°–ò–ì–ù–ê–õ AI</div>
                <div id="signal_text" style="font-size: 24px; font-weight: bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
                <div id="signal_confidence" style="font-size: 11px; margin-top: 2px;">–ù–∞–∂–º–∏—Ç–µ –ê–Ω–∞–ª–∏–∑</div>
            </div>

            <div id="tradePlanBox" class="trade-plan-box">
                <div style="text-align: center; font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">–¢–û–†–ì–û–í–´–ô –ü–õ–ê–ù</div>
                <div class="plan-row"><span>Entry</span><span id="aiEntry" style="color: #58a6ff">--</span></div>
                <div class="plan-row"><span>TP</span><span id="aiTP" style="color: var(--buy)">--</span></div>
                <div class="plan-row"><span>SL</span><span id="aiSL" style="color: var(--sell)">--</span></div>
            </div>

            <!-- –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ë–õ–û–ö –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-item"><span style="color: #8b949e;">RSI:</span><b id="statRsi">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">MACD:</span><b id="statMacd">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">ATR:</span><b id="statAtr">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">–¢—Ä–µ–Ω–¥:</span><b id="statTrend">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">EMA50:</span><b id="statEma50">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">EMA200:</span><b id="statEma200">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">BB –≤–µ—Ä—Ö:</span><b id="statBBupper">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">BB –Ω–∏–∑:</span><b id="statBBlower">-</b></div>
            </div>

            <div class="analysis-summary">
                <div class="summary-header" onclick="toggleAnalysis()">
                    <span>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞</span><span id="toggleIcon">‚ñº</span>
                </div>
                <div id="ai_desc" style="display: none;"></div>
            </div>

            <button onclick="runAnalysis()" id="analyzeBtn" type="button">–ê–Ω–∞–ª–∏–∑ (–∏–ª–∏ –∞–≤—Ç–æ 1 –º–∏–Ω)</button>

            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                <label style="font-size: 11px; color: #8b949e;">–ú–æ–¥–µ–ª—å –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π:</label>
                <select id="newsModelSelect">
                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                    <option value="anthropic/claude-3.5-haiku">Claude 3.5 Haiku</option>
                    <option value="deepseek/deepseek-v3.2" selected>DeepSeek V3.2</option>
                </select>

                <label style="font-size: 11px; color: #8b949e; margin-top: 8px; display: block;">–ú–æ–¥–µ–ª—å –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤:</label>
                <select id="analysisModelSelect">
                    <option value="deepseek/deepseek-v3.2" selected>DeepSeek V3.2</option>
                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                    <option value="anthropic/claude-sonnet-4.6">Claude 4.6 Sonnet</option>
                </select>

                <input type="password" id="api_key_input" placeholder="OpenRouter API Key (sk-or-...)" value="">
                <button class="small" onclick="saveSettings()" style="margin-top: 6px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>
    </div>

    <script>
        // ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
        const MOEX_BASE = "https://iss.moex.com/iss/engines/futures/markets/forts";
        const RSS_FEEDS = [
            'https://lenta.ru/rss/news',
            'https://www.vedomosti.ru/rss/articles',
            'https://feeds.bbci.co.uk/news/business/rss.xml',
            'https://www.ft.com/rss/world'
        ];

        let currentTicker = "SiH6";
        let currentInstrumentType = 'Si';
        let chart = null;
        let candleSeries = null;
        let priceLines = [];
        let historyData = [];
        let allNews = [];
        let currentPriceGlobal = 0;
        let lastAnalysisTime = 0;
        let lastAnalysisPrice = 0;
        const MIN_PRICE_CHANGE_PERCENT = 0.2;
        let lastSignal = { signal: "–û–ñ–ò–î–ê–ù–ò–ï", confidence: 0, entry: 0, tp: 0, sl: 0, reason: "", time: 0 };
        let analysisState = { newsScore: 0 };

        const antiCache = () => `_=${Date.now()}`;

        function getInstrumentType(ticker) {
            const u = ticker.toUpperCase();
            if (u.includes('SI')) return 'Si';
            if (u.includes('SR') || u.includes('SBER')) return 'SBER';
            if (u.includes('BR')) return 'BR';
            return 'unknown';
        }

        // ================= –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• MOEX =================
        async function fetchQuotes() {
            try {
                const res = await fetch(`${MOEX_BASE}/securities/${currentTicker}.json?iss.only=marketdata&${antiCache()}`);
                const data = await res.json();
                const row = data.marketdata.data[0];
                if (!row) return;

                const cols = data.marketdata.columns;
                const price = row[cols.indexOf('LAST')];
                const prev = row[cols.indexOf('PREVPRICE')];
                const time = row[cols.indexOf('SYSTIME')];

                currentPriceGlobal = price;
                document.getElementById('currentPrice').innerText = price.toFixed(2);
                if (prev > 0) {
                    const pct = ((price - prev) / prev * 100);
                    document.getElementById('changePercent').innerText = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
                    document.getElementById('changePercent').style.color = pct >= 0 ? 'var(--buy)' : 'var(--sell)';
                }
                if (time) {
                    document.getElementById('lastTradeTime').innerText = "–°–¥–µ–ª–∫–∞: " + new Date(time).toLocaleTimeString('ru-RU');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–µ—á—É
                if (candleSeries && historyData.length > 0) {
                    updateChartLive(price);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫:", e);
            }
        }

        function parseMoexTime(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hour, minute, second] = timePart.split(':').map(Number);
            return Math.floor(Date.UTC(year, month - 1, day, hour - 3, minute, second) / 1000);
        }

        async function fetchCandles() {
            const d = new Date();
            d.setDate(d.getDate() - 7);
            const from = d.toISOString().split('T')[0];
            try {
                const res = await fetch(`${MOEX_BASE}/securities/${currentTicker}/candles.json?interval=60&from=${from}&${antiCache()}`);
                const data = await res.json();
                if (!data.candles || !data.candles.data) return;
                const cols = data.candles.columns;
                historyData = data.candles.data.map(r => ({
                    time: parseMoexTime(r[cols.indexOf('begin')]),
                    open: r[cols.indexOf('open')],
                    high: r[cols.indexOf('high')],
                    low: r[cols.indexOf('low')],
                    close: r[cols.indexOf('close')]
                })).filter(c => c.close > 0);

                renderChart(historyData);
                calcTech(); // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ—á–µ–π
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ—á–µ–π:", e);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function updateChartLive(price) {
            if (!candleSeries || !historyData.length) return;

            const nowUtc = Math.floor(Date.now() / 1000);
            const mskOffset = 3 * 3600;
            const nowMsk = nowUtc + mskOffset;
            const tfSeconds = 60 * 60; // 1 —á–∞—Å
            const startOfIntervalMsk = Math.floor(nowMsk / tfSeconds) * tfSeconds;
            const currentCandleTime = startOfIntervalMsk - mskOffset;

            let lastCandle = historyData[historyData.length - 1];

            if (lastCandle.time === currentCandleTime) {
                lastCandle.close = price;
                if (price > lastCandle.high) lastCandle.high = price;
                if (price < lastCandle.low) lastCandle.low = price;
                candleSeries.update(lastCandle);
            } else {
                // –ù–æ–≤–∞—è —Å–≤–µ—á–∞ (—Ä–µ–¥–∫–æ, –Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
                historyData.push({
                    time: currentCandleTime,
                    open: lastCandle.close,
                    high: price,
                    low: price,
                    close: price
                });
                if (historyData.length > 500) historyData.shift();
                candleSeries.setData(historyData);
            }
        }

        // ================= –ù–û–í–û–°–¢–ò –ò –ü–ê–†–°–ò–ù–ì =================
        async function fetchNews() {
            let fetched = [];
            for (const url of RSS_FEEDS) {
                try {
                    const res = await fetch(`/api/rss?url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if (data.items) {
                        fetched.push(...data.items.map(i => ({
                            title: i.title,
                            time: new Date(i.pubDate),
                            text: (i.description || '').substring(0, 200)
                        })));
                    }
                } catch (e) {
                    console.warn("–û—à–∏–±–∫–∞ RSS:", url, e);
                }
            }
            fetched.sort((a, b) => b.time - a.time);
            const toAnalyze = fetched.slice(0, 20); // –±–µ—Ä—ë–º 20 —Å–≤–µ–∂–∏—Ö

            const key = document.getElementById('api_key_input').value.trim();
            const newsModel = document.getElementById('newsModelSelect').value;

            if (key) {
                try {
                    const prompt = `–¢—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –û—Ü–µ–Ω–∏ –≤–ª–∏—è–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ —Ñ—å—é—á–µ—Ä—Å ${currentInstrumentType}. 
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ sentiment (bullish, bearish, neutral) –∏ impact (high, medium, low).
–í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ JSON –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ markdown. –§–æ—Ä–º–∞—Ç: [{"sentiment": "...", "impact": "..."}, ...].
–ù–æ–≤–æ—Å—Ç–∏:
` + toAnalyze.map((n, i) => `${i + 1}. ${n.title}`).join('\n');

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            "Authorization": `Bearer ${key}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: newsModel,
                            messages: [{ role: "user", content: prompt }],
                            temperature: 0.1
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const data = await res.json();
                    let rawContent = data.choices[0].message.content;

                    // –û—á–∏—Å—Ç–∫–∞ –æ—Ç —Ç–µ–≥–æ–≤ –º—ã—à–ª–µ–Ω–∏—è –∏ markdown
                    let cleanContent = rawContent.replace(/<think>[\s\S]*?<\/think>/gi, '')
                        .replace(/```(?:json)?/gi, '')
                        .replace(/```/g, '')
                        .trim();

                    let results = [];
                    const match = cleanContent.match(/\[[\s\S]*\]/);
                    if (match) {
                        results = JSON.parse(match[0]);
                    } else {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞:", cleanContent);
                    }

                    toAnalyze.forEach((n, i) => {
                        n.sentiment = results[i]?.sentiment || 'neutral';
                        n.impact = results[i]?.impact || 'low';
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:", e);
                    toAnalyze.forEach(n => { n.sentiment = 'neutral'; n.impact = 'low'; });
                }
            } else {
                toAnalyze.forEach(n => { n.sentiment = 'neutral'; n.impact = 'low'; });
            }

            allNews = toAnalyze;

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤–æ—Å—Ç–Ω–æ–π —Å—á—ë—Ç —Å —É—á—ë—Ç–æ–º –≤–ª–∏—è–Ω–∏—è
            let bullishScore = 0, bearishScore = 0;
            allNews.forEach(n => {
                let weight = n.impact === 'high' ? 2 : (n.impact === 'medium' ? 1.5 : 1);
                if (n.sentiment === 'bullish') bullishScore += weight;
                if (n.sentiment === 'bearish') bearishScore += weight;
            });
            analysisState.newsScore = bullishScore - bearishScore;

            renderNews(allNews);
        }

        function renderNews(news) {
            document.getElementById('newsCount').innerText = news.length;
            document.getElementById('newsList').innerHTML = news.map(n => {
                const borderColor = n.sentiment === 'bullish' ? '#238636' : (n.sentiment === 'bearish' ? '#f85149' : '#3b82f6');
                const impactClass = n.impact === 'high' ? 'impact-high' : (n.impact === 'medium' ? 'impact-medium' : 'impact-low');
                const sentimentClass = n.sentiment === 'bullish' ? 'sentiment-bullish' : (n.sentiment === 'bearish' ? 'sentiment-bearish' : 'sentiment-neutral');
                return `
                    <div class="news-item" style="border-left-color: ${borderColor};">
                        <div class="news-time">
                            <span>${n.time.toLocaleTimeString()} <span class="news-sentiment ${sentimentClass}">${n.sentiment}</span></span>
                            <span class="${impactClass}" style="font-size:9px;">${n.impact}</span>
                        </div>
                        <div style="font-size: 11px;"><b>${n.title}</b></div>
                    </div>
                `;
            }).join('');
        }

        function filterNews(type, event) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            let filtered = type === 'all' ? allNews : allNews.filter(n => n.sentiment === type);
            renderNews(filtered);
        }

        // ================= –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó =================
        function calcTech() {
            if (historyData.length < 50) return null;
            const closes = historyData.map(d => d.close);
            const lastPrice = closes[closes.length - 1];

            // RSI (14)
            let gains = 0, losses = 0;
            for (let i = closes.length - 14; i < closes.length; i++) {
                let diff = closes[i] - closes[i - 1];
                if (diff > 0) gains += diff; else losses -= diff;
            }
            const rsi = losses === 0 ? 100 : 100 - (100 / (1 + gains / losses));

            // EMA (12, 26) –¥–ª—è MACD
            const ema = (p, per) => p.slice(1).reduce((e, v) => v * (2 / (per + 1)) + e * (1 - 2 / (per + 1)), p[0]);
            const macd = ema(closes, 12) - ema(closes, 26);

            // ATR (14)
            let tr = 0;
            for (let i = historyData.length - 14; i < historyData.length; i++) {
                const h = historyData[i].high, l = historyData[i].low, pc = historyData[i - 1].close;
                tr += Math.max(h - l, Math.abs(h - pc), Math.abs(l - pc));
            }
            const atr = tr / 14;

            // EMA50 –∏ EMA200
            const ema50 = ema(closes.slice(-50), 50);
            const ema200 = ema(closes, 200);

            // –ü–æ–ª–æ—Å—ã –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞ (20, 2)
            const periodBB = 20;
            const bbCloses = closes.slice(-periodBB);
            const mean = bbCloses.reduce((a, b) => a + b, 0) / periodBB;
            const stdDev = Math.sqrt(bbCloses.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / periodBB);
            const upperBB = mean + 2 * stdDev;
            const lowerBB = mean - 2 * stdDev;

            // –¢—Ä–µ–Ω–¥
            const trend = lastPrice > ema50 ? (lastPrice > ema200 ? 'STRONG_BULL' : 'BULL') : (lastPrice < ema200 ? 'STRONG_BEAR' : 'BEAR');

            document.getElementById('statRsi').innerText = rsi.toFixed(1);
            document.getElementById('statRsi').style.color = rsi > 70 ? 'var(--sell)' : (rsi < 30 ? 'var(--buy)' : 'var(--text)');
            document.getElementById('statMacd').innerText = macd.toFixed(2);
            document.getElementById('statAtr').innerText = atr.toFixed(2);
            document.getElementById('statTrend').innerText = trend;
            document.getElementById('statEma50').innerText = ema50.toFixed(2);
            document.getElementById('statEma200').innerText = ema200.toFixed(2);
            document.getElementById('statBBupper').innerText = upperBB.toFixed(2);
            document.getElementById('statBBlower').innerText = lowerBB.toFixed(2);

            return {
                price: lastPrice,
                rsi,
                atr,
                macd,
                trend,
                ema50,
                ema200,
                upperBB,
                lowerBB
            };
        }

        // ================= –ì–õ–ê–í–ù–´–ô –ê–ù–ê–õ–ò–ó –° –§–ò–õ–¨–¢–†–û–ú =================
        async function runAnalysis() {
            const key = document.getElementById('api_key_input').value.trim();
            const model = document.getElementById('analysisModelSelect').value;
            if (!key) {
                alert("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á");
                return;
            }

            const tech = calcTech();
            if (!tech) {
                console.log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞");
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...";
            btn.style.opacity = '0.5';
            document.getElementById('updateBadge').style.display = 'none';

            const memoryText = lastSignal.signal !== '–û–ñ–ò–î–ê–ù–ò–ï'
                ? `–¢–≤–æ–π –ü–†–ï–î–´–î–£–©–ò–ô —Å–∏–≥–Ω–∞–ª –±—ã–ª: ${lastSignal.signal}. –ï—Å–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ, –ü–û–î–¢–í–ï–†–î–ò –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–≥–Ω–∞–ª. –ù–µ –º–µ–Ω—è–π –ø–æ–∑–∏—Ü–∏—é –∏–∑-–∑–∞ –º–∏–∫—Ä–æ–∫–æ–ª–µ–±–∞–Ω–∏–π.`
                : '';

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–µ–π (–ø–µ—Ä–≤—ã–µ 5 —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤–ª–∏—è–Ω–∏—è)
            const newsContext = allNews.slice(0, 5).map(n => `[${n.impact}] ${n.title} (${n.sentiment})`).join('; ');
            const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä. –ê–∫—Ç–∏–≤: ${currentTicker}.
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞:
- –¶–µ–Ω–∞: ${tech.price.toFixed(2)}
- RSI (14): ${tech.rsi.toFixed(1)} ${tech.rsi > 70 ? '(–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å)' : tech.rsi < 30 ? '(–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å)' : ''}
- MACD: ${tech.macd.toFixed(2)} ${tech.macd > 0 ? '(–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π)' : '(–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π)'}
- ATR (14): ${tech.atr.toFixed(2)} (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
- EMA50: ${tech.ema50.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.ema50 ? '–≤—ã—à–µ' : '–Ω–∏–∂–µ'} EMA50)
- EMA200: ${tech.ema200.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.ema200 ? '–≤—ã—à–µ' : '–Ω–∏–∂–µ'} EMA200)
- –ü–æ–ª–æ—Å—ã –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞: –≤–µ—Ä—Ö ${tech.upperBB.toFixed(2)}, –Ω–∏–∑ ${tech.lowerBB.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.upperBB ? '–≤—ã—à–µ –≤–µ—Ä—Ö–Ω–µ–π' : tech.price < tech.lowerBB ? '–Ω–∏–∂–µ –Ω–∏–∂–Ω–µ–π' : '–≤–Ω—É—Ç—Ä–∏'})

–ù–æ–≤–æ—Å—Ç–∏ (–æ–±—â–∏–π —Å–∫–æ—Ä: ${analysisState.newsScore.toFixed(1)}): ${newsContext}

${memoryText}

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ JSON (–∫–ª—é—á–∏: signal (–ü–û–ö–£–ü–ö–ê/–ü–†–û–î–ê–ñ–ê/–î–ï–†–ñ–ê–¢–¨), confidence (0-100), entry (–≤—Ö–æ–¥), tp (—Ç—ç–π–∫), sl (—Å—Ç–æ–ø), reason (–ø–æ—á–µ–º—É)). 
–î–ª—è –ü–û–ö–£–ü–ö–ê: entry = —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞, tp = entry + 1.5*ATR, sl = entry - 1*ATR.
–î–ª—è –ü–†–û–î–ê–ñ–ê: entry = —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞, tp = entry - 1.5*ATR, sl = entry + 1*ATR.
–ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –î–ï–†–ñ–ê–¢–¨, entry/tp/sl = 0.
–ë–µ–∑ markdown, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ JSON.`;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.origin,
                        "X-Title": "AI Terminal"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errText}`);
                }

                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                let rawContent = data.choices[0].message.content;

                // –û—á–∏—Å—Ç–∫–∞ –æ—Ç —Ç–µ–≥–æ–≤ –º—ã—à–ª–µ–Ω–∏—è –∏ markdown
                let cleanContent = rawContent.replace(/<think>[\s\S]*?<\/think>/gi, '')
                    .replace(/```(?:json)?/gi, '')
                    .replace(/```/g, '')
                    .trim();

                const match = cleanContent.match(/\{[\s\S]*\}/);
                if (!match) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ");
                const json = JSON.parse(match[0]);

                // –û–±–Ω–æ–≤–ª—è–µ–º lastAnalysisTime –∏ lastAnalysisPrice
                lastAnalysisTime = Date.now();
                lastAnalysisPrice = tech.price;

                processNewSignal(json, tech.price);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞:", e);
                document.getElementById('ai_desc').innerText = "–û—à–∏–±–∫–∞: " + e.message;
                document.getElementById('ai_desc').style.display = 'block';
            } finally {
                btn.innerText = "–ê–Ω–∞–ª–∏–∑ (–∏–ª–∏ –∞–≤—Ç–æ 1 –º–∏–Ω)";
                btn.style.opacity = '1';
            }
        }

        function processNewSignal(newSignal, currentPrice) {
            let shouldRedraw = false;
            if (newSignal.signal !== lastSignal.signal) shouldRedraw = true;
            if (Math.abs(newSignal.confidence - lastSignal.confidence) >= 15) shouldRedraw = true;

            if (lastSignal.signal !== '–û–ñ–ò–î–ê–ù–ò–ï' && lastSignal.tp && lastSignal.sl) {
                if (lastSignal.signal === '–ü–û–ö–£–ü–ö–ê' && (currentPrice >= lastSignal.tp || currentPrice <= lastSignal.sl)) shouldRedraw = true;
                if (lastSignal.signal === '–ü–†–û–î–ê–ñ–ê' && (currentPrice <= lastSignal.tp || currentPrice >= lastSignal.sl)) shouldRedraw = true;
            }

            if (shouldRedraw || lastSignal.signal === '–û–ñ–ò–î–ê–ù–ò–ï') {
                lastSignal = { ...newSignal, time: Date.now() };
                updateUI(lastSignal);
                drawLines(lastSignal.entry, lastSignal.tp, lastSignal.sl);
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ (Web Audio)
                playAlertSound();
            } else {
                const badge = document.getElementById('updateBadge');
                badge.innerText = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ ${new Date().toLocaleTimeString()}`;
                badge.style.display = 'block';
                document.getElementById('ai_desc').innerText = newSignal.reason;
                document.getElementById('ai_desc').style.display = 'block';
            }
        }

        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.value = 523.25;
                gainNode.gain.value = 0.1;
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", e);
            }
        }

        function updateUI(j) {
            const ui = document.getElementById('signal_ui');
            ui.className = "signal-display " + (j.signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : j.signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold');
            document.getElementById('signal_text').innerText = j.signal;
            document.getElementById('signal_confidence').innerText = `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${j.confidence}%`;
            document.getElementById('ai_desc').innerText = j.reason;
            document.getElementById('ai_desc').style.display = 'block';

            if (j.entry > 0) {
                document.getElementById('tradePlanBox').style.display = 'block';
                document.getElementById('aiEntry').innerText = Number(j.entry).toFixed(2);
                document.getElementById('aiTP').innerText = Number(j.tp).toFixed(2);
                document.getElementById('aiSL').innerText = Number(j.sl).toFixed(2);
            } else {
                document.getElementById('tradePlanBox').style.display = 'none';
            }
        }

        // ================= –ì–†–ê–§–ò–ö–ò =================
        function renderChart(data) {
            const cont = document.getElementById('chart');
            cont.innerHTML = '';
            chart = LightweightCharts.createChart(cont, {
                layout: { background: { color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                timeScale: { timeVisible: true },
                width: cont.clientWidth,
                height: 400
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#f85149' });
            candleSeries.setData(data);
            if (lastSignal.entry) drawLines(lastSignal.entry, lastSignal.tp, lastSignal.sl);
            chart.timeScale().fitContent();
        }

        function drawLines(entry, tp, sl) {
            if (!candleSeries || entry === 0) return;
            priceLines.forEach(l => candleSeries.removePriceLine(l));
            priceLines = [];
            priceLines.push(candleSeries.createPriceLine({ price: entry, color: '#58a6ff', lineWidth: 2, lineStyle: 1, title: 'Entry' }));
            priceLines.push(candleSeries.createPriceLine({ price: tp, color: '#238636', lineWidth: 2, lineStyle: 1, title: 'TP' }));
            priceLines.push(candleSeries.createPriceLine({ price: sl, color: '#f85149', lineWidth: 2, lineStyle: 1, title: 'SL' }));
        }

        // ================= –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ò–ö–ï–†–û–ú =================
        function setTicker(ticker) {
            currentTicker = ticker;
            currentInstrumentType = getInstrumentType(ticker);
            document.getElementById('tickerInput').value = ticker;
            document.getElementById('tickerDisplay').innerText = ticker;
            lastSignal = { signal: "–û–ñ–ò–î–ê–ù–ò–ï", confidence: 0, entry: 0, tp: 0, sl: 0, reason: "", time: 0 };
            updateUI(lastSignal);
            fetchCandles();
            fetchQuotes();
            fetchNews();
        }

        function applyTicker() {
            const newTicker = document.getElementById('tickerInput').value.trim();
            if (newTicker) setTicker(newTicker);
        }

        function toggleAnalysis() {
            const d = document.getElementById('ai_desc');
            const icon = document.getElementById('toggleIcon');
            if (d.style.display === 'none') {
                d.style.display = 'block';
                icon.innerText = '‚ñº';
            } else {
                d.style.display = 'none';
                icon.innerText = '‚ñ∂';
            }
        }

        // ================= –ê–í–¢–û–ê–ù–ê–õ–ò–ó =================
        function startAutoAnalysis() {
            setInterval(() => {
                const key = document.getElementById('api_key_input').value.trim();
                if (!key) return;

                const currentPrice = parseFloat(document.getElementById('currentPrice').innerText);
                if (isNaN(currentPrice) || currentPrice === 0) return;

                const now = Date.now();
                if (lastAnalysisPrice === 0) lastAnalysisPrice = currentPrice;
                const priceChangePercent = Math.abs((currentPrice - lastAnalysisPrice) / lastAnalysisPrice * 100);
                const timeSinceLastAnalysis = now - lastAnalysisTime;

                if (priceChangePercent >= MIN_PRICE_CHANGE_PERCENT || timeSinceLastAnalysis > 10 * 60 * 1000) {
                    console.log(`–ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã ${priceChangePercent.toFixed(2)}%`);
                    runAnalysis();
                } else {
                    console.log(`–ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø—É—â–µ–Ω: –∏–∑–º–µ–Ω–µ–Ω–∏–µ ${priceChangePercent.toFixed(2)}%`);
                }
            }, 60000); // –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        }

        // ================= –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê–°–¢–†–û–ï–ö =================
        function saveSettings() {
            localStorage.setItem('si_k', document.getElementById('api_key_input').value);
            localStorage.setItem('n_m', document.getElementById('newsModelSelect').value);
            localStorage.setItem('a_m', document.getElementById('analysisModelSelect').value);
            alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        }

        // ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =================
        window.onload = () => {
            if (localStorage.getItem('si_k')) document.getElementById('api_key_input').value = localStorage.getItem('si_k');
            if (localStorage.getItem('n_m')) document.getElementById('newsModelSelect').value = localStorage.getItem('n_m');
            if (localStorage.getItem('a_m')) document.getElementById('analysisModelSelect').value = localStorage.getItem('a_m');

            setTicker('SiH6');

            setInterval(fetchQuotes, 5000);
            setInterval(fetchNews, 600000); // –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

            startAutoAnalysis();
        };
    </script>
</body>
</html>
