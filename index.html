<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; --buy: #238636; --sell: #f85149; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
        h2 { text-align: center; font-size: clamp(1.1rem, 4vw, 1.6rem); margin: 0 0 12px 0; }
        .grid { display: grid; grid-template-columns: 2.2fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        #chart { height: 400px; width: 100%; position: relative; background: var(--card); border-radius: 12px; overflow: hidden; }
        
        .ticker-wrap { display: flex; justify-content: space-between; background: #0d1117; padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ticker-val { font-size: 24px; font-weight: 700; font-family: 'Courier New'; }
        .ticker-label { font-size: 10px; color: #8b949e; margin-bottom: 2px; }
        
        .signal-display { text-align: center; padding: 12px; border-radius: 16px; border: 2px solid var(--border); margin-bottom: 8px; transition: 0.3s; position: relative; }
        .signal-display.buy { border-color: var(--buy); color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .signal-display.sell { border-color: var(--sell); color: var(--sell); background: rgba(248, 81, 73, 0.1); }
        .signal-display.hold { border-color: #d29922; color: #d29922; background: rgba(210, 153, 34, 0.1); }
        
        .update-badge { position: absolute; top: 8px; right: 8px; font-size: 9px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px; display: none; }

        .trade-plan-box { margin-top: 10px; background: #0d1117; border-radius: 12px; padding: 10px; border: 1px solid var(--border); display: none; }
        .plan-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .plan-row:last-child { border-bottom: none; }
        
        .news-box { margin-top: 12px; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .news-item { padding: 8px; border-left: 4px solid #3b82f6; margin-bottom: 6px; background: rgba(255,255,255,0.02); }
        .news-time { color: #60a5fa; font-size: 10px; font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }
        .news-sentiment { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 600; margin-top: 4px; }
        .sentiment-bullish { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .sentiment-bearish { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .sentiment-neutral { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        
        .news-filter { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .filter-btn { background: #21262d; color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 12px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-item { background: #0d1117; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between;}
        
        button { background: var(--accent); color: white; border: none; padding: 12px 16px; cursor: pointer; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.small { background: #21262d; width: auto; padding: 8px 12px; margin-top: 0; font-size: 12px; }
        
        input, select { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 10px; margin-top: 6px; font-size: 13px; }
        
        .analysis-summary { margin-top: 12px; background: #0d1117; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .summary-header { display: flex; justify-content: space-between; padding: 8px 12px; background: #161b22; cursor: pointer; font-size: 12px; font-weight: 600; color: #8b949e; }
        #ai_desc { padding: 10px; font-size: 12px; line-height: 1.5; color: var(--text); border-top: 1px solid var(--border); white-space: pre-wrap; }

        .ticker-controls { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .ticker-input { flex: 1; }
        .ticker-btn { background: #21262d; border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }

        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h2>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>

    <div class="grid">
        <div class="card">
            <div class="ticker-controls">
                <input type="text" id="tickerInput" class="ticker-input" placeholder="–ö–æ–¥ (SiH6)" value="SiH6">
                <button class="ticker-btn" onclick="setTicker('SiH6')">Si</button>
                <button class="ticker-btn" onclick="setTicker('SRH6')">SBER</button>
                <button class="ticker-btn" onclick="setTicker('BRH6')">BR</button>
                <button class="ticker-btn" onclick="applyTicker()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>

            <div id="chart"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: #8b949e;">
                <span id="contractName">–ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span id="tickerDisplay">SiH6</span></span>
                <span id="lastTradeTime">--</span>
            </div>

            <div class="news-box" id="newsBox">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600; color: #3b82f6;">–ù–æ–≤–æ—Å—Ç–∏</span>
                    <span id="newsCount" style="color:#8b949e; font-size: 11px;">0</span>
                </div>
                <div class="news-filter">
                    <button class="filter-btn active" onclick="filterNews('all', event)">–í—Å–µ</button>
                    <button class="filter-btn" onclick="filterNews('bullish', event)">–ë—ã—á—å–∏</button>
                    <button class="filter-btn" onclick="filterNews('bearish', event)">–ú–µ–¥–≤–µ–∂—å–∏</button>
                    <button class="filter-btn" onclick="fetchNews()">üîÑ</button>
                </div>
                <div id="newsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <div class="card">
            <div class="ticker-wrap">
                <div>
                    <div class="ticker-label">–ü–û–°–õ–ï–î–ù–Ø–Ø –¶–ï–ù–ê</div>
                    <div class="ticker-val" id="currentPrice">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="ticker-label">–ò–ó–ú–ï–ù–ï–ù–ò–ï</div>
                    <div class="ticker-val" id="changePercent">--</div>
                </div>
            </div>

            <div id="signal_ui" class="signal-display hold">
                <div id="updateBadge" class="update-badge">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</div>
                <div style="font-size: 10px; opacity: 0.7;">–°–ò–ì–ù–ê–õ AI</div>
                <div id="signal_text" style="font-size: 24px; font-weight: bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
                <div id="signal_confidence" style="font-size: 11px; margin-top: 2px;">–ù–∞–∂–º–∏—Ç–µ –ê–Ω–∞–ª–∏–∑</div>
            </div>

            <div id="tradePlanBox" class="trade-plan-box">
                <div style="text-align: center; font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">–¢–û–†–ì–û–í–´–ô –ü–õ–ê–ù</div>
                <div class="plan-row"><span>Entry</span><span id="aiEntry" style="color: #58a6ff">--</span></div>
                <div class="plan-row"><span>TP</span><span id="aiTP" style="color: var(--buy)">--</span></div>
                <div class="plan-row"><span>SL</span><span id="aiSL" style="color: var(--sell)">--</span></div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-item"><span style="color: #8b949e;">RSI:</span><b id="statRsi">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">MACD:</span><b id="statMacd">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">ATR:</span><b id="statAtr">-</b></div>
                <div class="stat-item"><span style="color: #8b949e;">–¢—Ä–µ–Ω–¥:</span><b id="statTrend">-</b></div>
            </div>

            <div class="analysis-summary">
                <div class="summary-header" onclick="toggleAnalysis()">
                    <span>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞</span><span id="toggleIcon">‚ñº</span>
                </div>
                <div id="ai_desc" style="display: none;"></div>
            </div>

            <button onclick="runAnalysis()" id="analyzeBtn" type="button">–ê–Ω–∞–ª–∏–∑ (–∏–ª–∏ –∞–≤—Ç–æ 1 –º–∏–Ω)</button>

            <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                <label style="font-size: 11px; color: #8b949e;">–ü–∞—Ä—Å–∏–Ω–≥ –Ω–æ–≤–æ—Å—Ç–µ–π (json):</label>
                <select id="newsModelSelect">
                    <option value="google/gemini-2.0-flash-001" selected>Gemini 2.0 Flash</option>
                    <option value="anthropic/claude-3.5-haiku">Claude 3.5 Haiku</option>
                </select>

                <label style="font-size: 11px; color: #8b949e; margin-top: 8px; display: block;">–õ–æ–≥–∏–∫–∞ –∏ —Å–∏–≥–Ω–∞–ª—ã (reasoning):</label>
                <select id="analysisModelSelect">
                    <option value="deepseek/deepseek-r1" selected>DeepSeek R1</option>
                    <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                </select>

                <input type="password" id="api_key_input" placeholder="OpenRouter API Key (sk-or-...)">
                <button class="small" onclick="saveSettings()" style="margin-top: 6px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á</button>
            </div>
        </div>
    </div>

    <script>
                // ================= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =================
        const MOEX_BASE = "https://iss.moex.com/iss/engines/futures/markets/forts";
        const RSS_FEEDS = ['https://lenta.ru/rss/news', 'https://www.vedomosti.ru/rss/articles'];

        let currentTicker = "SiH6", currentInstrumentType = 'Si';
        let chart = null, candleSeries = null, priceLines = [];
        let historyData = [], allNews = [], currentPriceGlobal = 0;
        let analysisState = { newsScore: 0 };
        
        let lastSignal = { signal: '–û–ñ–ò–î–ê–ù–ò–ï', confidence: 0, tp: 0, sl: 0, time: 0 };
        let autoAnalysisInterval = null;

        const antiCache = () => `_=${Date.now()}`;

        // üëá –í–û–¢ –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –ù–£–ñ–ù–û –í–ï–†–ù–£–¢–¨ üëá
        function getInstrumentType(ticker) {
            const u = ticker.toUpperCase();
            if (u.includes('SI')) return 'Si';
            if (u.includes('SR') || u.includes('SBER')) return 'SBER';
            if (u.includes('BR')) return 'BR';
            return 'unknown';
        }
        // üëÜ üëÜ üëÜ

        // ================= –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• MOEX =================

        async function fetchQuotes() {
            try {
                const res = await fetch(`${MOEX_BASE}/securities/${currentTicker}.json?iss.only=marketdata&${antiCache()}`);
                const data = await res.json();
                const row = data.marketdata.data[0];
                if(!row) return;
                
                const cols = data.marketdata.columns;
                const price = row[cols.indexOf('LAST')];
                const prev = row[cols.indexOf('PREVPRICE')];
                
                currentPriceGlobal = price;
                document.getElementById('currentPrice').innerText = price.toFixed(2);
                
                const pct = ((price - prev)/prev * 100);
                document.getElementById('changePercent').innerText = (pct>=0?'+':'')+pct.toFixed(2)+'%';
                document.getElementById('changePercent').style.color = pct>=0?'var(--buy)':'var(--sell)';
            } catch(e) {}
        }

        async function fetchCandles() {
            const d = new Date(); d.setDate(d.getDate() - 7);
            const from = d.toISOString().split('T')[0];
            try {
                const res = await fetch(`${MOEX_BASE}/securities/${currentTicker}/candles.json?interval=60&from=${from}&${antiCache()}`);
                const data = await res.json();
                const cols = data.candles.columns;
                historyData = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[cols.indexOf('begin')]).getTime() / 1000) - (3*3600),
                    open: r[cols.indexOf('open')], high: r[cols.indexOf('high')], 
                    low: r[cols.indexOf('low')], close: r[cols.indexOf('close')]
                }));
                renderChart(historyData);
                calcTech(); // –°—á–∏—Ç–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            } catch(e) {}
        }

        // ================= –ù–û–í–û–°–¢–ò =================
        async function fetchNews() {
            let fetched = [];
            for (const url of RSS_FEEDS) {
                try {
                    const res = await fetch(`/api/rss?url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if(data.items) fetched.push(...data.items.map(i => ({
                        title: i.title, time: new Date(i.pubDate), text: i.description?.substring(0,100)
                    })));
                } catch(e) {}
            }
            fetched.sort((a,b) => b.time - a.time);
            const toAnalyze = fetched.slice(0, 15);
            
            const key = document.getElementById('api_key_input').value.trim();
            const newsModel = document.getElementById('newsModelSelect').value;
            
            if(key) {
                try {
                    const prompt = `–û—Ü–µ–Ω–∏ –≤–ª–∏—è–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ ${currentInstrumentType}. –í–µ—Ä–Ω–∏ JSON –º–∞—Å—Å–∏–≤: [{"sentiment": "bullish"|"bearish"|"neutral"}].\n` + toAnalyze.map((n,i) => `${i+1}. ${n.title}`).join('\n');
                    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST', headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ model: newsModel, messages: [{role:"user", content: prompt}], temperature: 0 })
                    });
                    const data = await res.json();
                    const content = data.choices[0].message.content.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
                    const results = JSON.parse(content.match(/\[[\s\S]*\]/)[0]);
                    
                    toAnalyze.forEach((n, i) => n.sentiment = results[i]?.sentiment || 'neutral');
                } catch(e) { toAnalyze.forEach(n => n.sentiment = 'neutral'); }
            } else {
                toAnalyze.forEach(n => n.sentiment = 'neutral');
            }

            allNews = toAnalyze;
            
            // –°—á–∏—Ç–∞–µ–º —Å–∫–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π
            let b=0, m=0;
            allNews.forEach(n => { if(n.sentiment==='bullish') b++; if(n.sentiment==='bearish') m++; });
            analysisState.newsScore = b - m;

            renderNews(allNews);
        }

        function renderNews(news) {
            document.getElementById('newsCount').innerText = news.length;
            document.getElementById('newsList').innerHTML = news.map(n => `
                <div class="news-item" style="border-left-color: ${n.sentiment === 'bullish'?'#238636':n.sentiment==='bearish'?'#f85149':'#3b82f6'}">
                    <div class="news-time">${n.time.toLocaleTimeString()} <span class="news-sentiment sentiment-${n.sentiment}">${n.sentiment}</span></div>
                    <div style="font-size: 11px;"><b>${n.title}</b></div>
                </div>
            `).join('');
        }

        // ================= –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó (–ß–ï–°–¢–ù–´–ô) =================
        function calcTech() {
            if(historyData.length < 50) return null;
            const closes = historyData.map(d => d.close);
            const last = closes[closes.length-1];

            // –ü—Ä–æ—Å—Ç–æ–π RSI
            let gains = 0, losses = 0;
            for(let i = closes.length - 14; i < closes.length; i++){
                let diff = closes[i] - closes[i-1];
                if(diff > 0) gains += diff; else losses -= diff;
            }
            const rsi = losses === 0 ? 100 : 100 - (100 / (1 + gains/losses));

            // EMA –∏ Trend
            const ema50 = closes.slice(-50).reduce((a,b)=>a+b)/50;
            const ema200 = closes.slice(-200).reduce((a,b)=>a+b)/200;
            const trend = last > ema50 && last > ema200 ? 'BULL' : (last < ema50 && last < ema200 ? 'BEAR' : 'FLAT');

            // ATR (–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
            let tr = 0;
            for(let i = historyData.length - 14; i < historyData.length; i++) {
                tr += Math.max(historyData[i].high - historyData[i].low, Math.abs(historyData[i].high - closes[i-1]));
            }
            const atr = tr / 14;

            // MACD (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
            const macd = (closes.slice(-12).reduce((a,b)=>a+b)/12) - (closes.slice(-26).reduce((a,b)=>a+b)/26);

            document.getElementById('statRsi').innerText = rsi.toFixed(1);
            document.getElementById('statRsi').style.color = rsi>70 ? 'var(--sell)' : rsi<30 ? 'var(--buy)' : 'var(--text)';
            document.getElementById('statMacd').innerText = macd.toFixed(2);
            document.getElementById('statAtr').innerText = atr.toFixed(2);
            document.getElementById('statTrend').innerText = trend;

            return { price: last, rsi, atr, macd, trend };
        }

        // ================= –ì–õ–ê–í–ù–´–ô –ê–ù–ê–õ–ò–ó –° –§–ò–õ–¨–¢–†–û–ú (–ì–ò–°–¢–ï–†–ï–ó–ò–°) =================
        async function runAnalysis() {
            const key = document.getElementById('api_key_input').value.trim();
            const model = document.getElementById('analysisModelSelect').value;
            if(!key) { alert("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á"); return; }

            const tech = calcTech();
            if(!tech) return;

            const btn = document.getElementById('analyzeBtn');
            btn.innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é..."; btn.style.opacity = '0.5';
            document.getElementById('updateBadge').style.display = 'none';

            // –î–û–ë–ê–í–õ–Ø–ï–ú –ü–ê–ú–Ø–¢–¨ –í –ü–†–û–ú–ü–¢! –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç —Ö–∞–æ—Ç–∏—á–Ω—ã–µ —Å–∫–∞—á–∫–∏
            const memoryText = lastSignal.signal !== '–û–ñ–ò–î–ê–ù–ò–ï' 
                ? `–¢–≤–æ–π –ü–†–ï–î–´–î–£–©–ò–ô —Å–∏–≥–Ω–∞–ª –±—ã–ª: ${lastSignal.signal}. –ï—Å–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∏ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ, –ü–û–î–¢–í–ï–†–î–ò –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–≥–Ω–∞–ª. –ù–µ –º–µ–Ω—è–π –ø–æ–∑–∏—Ü–∏—é –∏–∑-–∑–∞ –º–∏–∫—Ä–æ–∫–æ–ª–µ–±–∞–Ω–∏–π.`
                : '';

            const prompt = `–¢—ã —Ç—Ä–µ–π–¥–µ—Ä. –ê–∫—Ç–∏–≤: ${currentTicker}.
            –¢–µ—Ö–Ω–∏–∫–∞: –¶–µ–Ω–∞: ${tech.price}, RSI: ${tech.rsi.toFixed(1)}, MACD: ${tech.macd.toFixed(2)}, –¢—Ä–µ–Ω–¥: ${tech.trend}, ATR(–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å): ${tech.atr.toFixed(2)}.
            –ù–æ–≤–æ—Å—Ç–∏ (–°–∫–æ—Ä: ${analysisState.newsScore}): ${allNews.slice(0,3).map(n=>n.title).join('; ')}.
            
            ${memoryText}
            
            –û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ JSON (–∫–ª—é—á–∏: signal (–ü–û–ö–£–ü–ö–ê/–ü–†–û–î–ê–ñ–ê/–î–ï–†–ñ–ê–¢–¨), confidence (0-100), entry (–≤—Ö–æ–¥), tp (—Ç—ç–π–∫), sl (—Å—Ç–æ–ø), reason (–ø–æ—á–µ–º—É)). 
            –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –î–ï–†–ñ–ê–¢–¨, entry/tp/sl = 0. –ë–µ–∑ markdown.`;

            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST', headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: model, messages: [{role:"user", content: prompt}], temperature: 0.1 })
                });
                const data = await res.json();
                const content = data.choices[0].message.content.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
                const json = JSON.parse(content.match(/\{[\s\S]*\}/)[0]);
                
                processNewSignal(json, tech.price);
            } catch(e) { console.error("–û—à–∏–±–∫–∞ AI", e); }
            
            btn.innerText = "–ê–Ω–∞–ª–∏–∑ (–∏–ª–∏ –∞–≤—Ç–æ 1 –º–∏–Ω)"; btn.style.opacity = '1';
        }

        // –õ–æ–≥–∏–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –¥—Ä–µ–±–µ–∑–≥–∞ (Hysteresis Filter)
        function processNewSignal(newSignal, currentPrice) {
            let shouldRedraw = false;

            // 1. –ò–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ë—ã–ª BUY, —Å—Ç–∞–ª SELL)
            if (newSignal.signal !== lastSignal.signal) shouldRedraw = true;
            
            // 2. –°–∏–≥–Ω–∞–ª —Ç–æ—Ç –∂–µ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞/–≤—ã—Ä–æ—Å–ª–∞ –û–ß–ï–ù–¨ —Å–∏–ª—å–Ω–æ (> 15%)
            if (Math.abs(newSignal.confidence - lastSignal.confidence) >= 15) shouldRedraw = true;

            // 3. –¶–µ–Ω–∞ –ø—Ä–æ–±–∏–ª–∞ —Å—Ç–∞—Ä—ã–π –¢–µ–π–∫ –∏–ª–∏ –°—Ç–æ–ø (–ù—É–∂–µ–Ω –Ω–æ–≤—ã–π –ø–ª–∞–Ω)
            if (lastSignal.signal !== '–û–ñ–ò–î–ê–ù–ò–ï' && lastSignal.tp && lastSignal.sl) {
                if (lastSignal.signal === '–ü–û–ö–£–ü–ö–ê' && (currentPrice >= lastSignal.tp || currentPrice <= lastSignal.sl)) shouldRedraw = true;
                if (lastSignal.signal === '–ü–†–û–î–ê–ñ–ê' && (currentPrice <= lastSignal.tp || currentPrice >= lastSignal.sl)) shouldRedraw = true;
            }

            if (shouldRedraw || lastSignal.signal === '–û–ñ–ò–î–ê–ù–ò–ï') {
                // –û–ë–ù–û–í–õ–Ø–ï–ú –ü–û–õ–ù–û–°–¢–¨–Æ
                lastSignal = { ...newSignal, time: Date.now() };
                updateUI(lastSignal);
                drawLines(lastSignal.entry, lastSignal.tp, lastSignal.sl);
            } else {
                // –ü–†–û–°–¢–û –ü–û–î–¢–í–ï–†–ñ–î–ê–ï–ú, –ß–¢–û –í–°–ï –û–ö (–ë–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤)
                const badge = document.getElementById('updateBadge');
                badge.innerText = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –≤ ${new Date().toLocaleTimeString()}`;
                badge.style.display = 'block';
                // –°–ª–µ–≥–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥
                document.getElementById('ai_desc').innerText = newSignal.reason;
            }
        }

        function updateUI(j) {
            const ui = document.getElementById('signal_ui');
            ui.className = "signal-display " + (j.signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : j.signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold');
            document.getElementById('signal_text').innerText = j.signal;
            document.getElementById('signal_confidence').innerText = `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${j.confidence}%`;
            document.getElementById('ai_desc').innerText = j.reason;
            
            if(j.entry > 0) {
                document.getElementById('tradePlanBox').style.display = 'block';
                document.getElementById('aiEntry').innerText = Number(j.entry).toFixed(2);
                document.getElementById('aiTP').innerText = Number(j.tp).toFixed(2);
                document.getElementById('aiSL').innerText = Number(j.sl).toFixed(2);
            } else {
                document.getElementById('tradePlanBox').style.display = 'none';
            }
        }

        // ================= –ì–†–ê–§–ò–ö–ò =================
        function renderChart(data) {
            const cont = document.getElementById('chart');
            cont.innerHTML = '';
            chart = LightweightCharts.createChart(cont, {
                layout: { background: { color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                width: cont.clientWidth, height: 400
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#f85149' });
            candleSeries.setData(data);
            if(lastSignal.entry) drawLines(lastSignal.entry, lastSignal.tp, lastSignal.sl);
        }

        function drawLines(entry, tp, sl) {
            if(!candleSeries || entry === 0) return;
            priceLines.forEach(l => candleSeries.removePriceLine(l));
            priceLines = [];
            priceLines.push(candleSeries.createPriceLine({ price: entry, color: '#58a6ff', lineWidth: 2, title: 'Entry' }));
            priceLines.push(candleSeries.createPriceLine({ price: tp, color: '#238636', lineWidth: 2, title: 'TP' }));
            priceLines.push(candleSeries.createPriceLine({ price: sl, color: '#f85149', lineWidth: 2, title: 'SL' }));
        }

        // ================= –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø =================
        function setTicker(t) { 
            currentTicker = t; currentInstrumentType = getInstrumentType(t);
            document.getElementById('tickerInput').value = t;
            document.getElementById('tickerDisplay').innerText = t;
            lastSignal = { signal: '–û–ñ–ò–î–ê–ù–ò–ï', confidence: 0 }; // –°–±—Ä–æ—Å –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–∫–µ—Ä–∞
            updateUI(lastSignal);
            fetchCandles(); fetchQuotes(); fetchNews(); 
        }

        function toggleAnalysis() { 
            const d = document.getElementById('ai_desc'); 
            d.style.display = d.style.display === 'none' ? 'block' : 'none'; 
        }

        function filterNews(type, e) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            let filtered = type === 'all' ? allNews : allNews.filter(n => n.sentiment === type);
            renderNews(filtered);
        }

        function saveSettings() { 
            localStorage.setItem('si_k', document.getElementById('api_key_input').value); 
            localStorage.setItem('n_m', document.getElementById('newsModelSelect').value);
            localStorage.setItem('a_m', document.getElementById('analysisModelSelect').value);
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); 
        }

        window.onload = () => {
            if(localStorage.getItem('si_k')) document.getElementById('api_key_input').value = localStorage.getItem('si_k');
            if(localStorage.getItem('n_m')) document.getElementById('newsModelSelect').value = localStorage.getItem('n_m');
            if(localStorage.getItem('a_m')) document.getElementById('analysisModelSelect').value = localStorage.getItem('a_m');

            setTicker('SiH6');
            
            // –ö–æ—Ç–∏—Ä–æ–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
            setInterval(fetchQuotes, 5000);
            
            // –ê–≤—Ç–æ-–ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∏—Ö–æ, –æ–±–Ω–æ–≤–ª—è–µ—Ç UI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–¥–æ)
            autoAnalysisInterval = setInterval(() => {
                if (document.getElementById('api_key_input').value.trim()) {
                    runAnalysis();
                }
            }, 60000);
        };
    </script>
</body>
</html>
