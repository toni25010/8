async function classifyNewsBatch(newsItems, instrumentType) {
    const key = document.getElementById('api_key_input').value.trim();
    const model = document.getElementById('modelSelect').value;
    
    if (!key) {
        showAIFallbackWarning(true);
        return newsItems.map(() => ({ sentiment: 'neutral', impact: 'low' }));
    }
    
    if (newsItems.length === 0) return [];

    let instruction = '';
    if (instrumentType === 'Si') {
        instruction = `Ты аналитик, специализирующийся на влиянии новостей на курс рубля (фьючерс Si). 
Для каждой новости определи sentiment и impact в формате JSON.
- sentiment: "bullish" (рубль слабеет → доллар растёт) если новость негативна для РФ (санкции, война, падение нефти, кризис)
- sentiment: "bearish" (рубль укрепляется) если новость позитивна для РФ (рост нефти, переговоры, успехи экономики)
- sentiment: "neutral" если нет явного влияния.
- impact: "high" (сильное влияние), "medium" (среднее), "low" (слабое) — оцени важность новости для валютного рынка.`;
    } else if (instrumentType === 'SBER') {
        instruction = `Ты аналитик, специализирующийся на влиянии новостей на акции Сбера (Sberbank).
Для каждой новости определи sentiment и impact.
- sentiment: "bullish" (позитивно для акций), "bearish" (негативно), "neutral".
- impact: "high", "medium", "low" — оцени значимость новости для банковского сектора.`;
    } else if (instrumentType === 'BR') {
        instruction = `Ты аналитик, специализирующийся на влиянии новостей на цену нефти Brent.
Для каждой новости определи sentiment и impact.
- sentiment: "bullish" (рост цен), "bearish" (падение), "neutral".
- impact: "high", "medium", "low" — оцени важность новости для нефтяного рынка.`;
    } else {
        instruction = `Для каждой новости определи sentiment (bullish/bearish/neutral) и impact (high/medium/low).`;
    }

    let prompt = instruction + "\n\nВерни JSON-массив в формате [{\"sentiment\": \"bullish\", \"impact\": \"high\"}, ...] или объект {\"results\": [...]}. Без пояснений.\n\nНовости:\n";
    newsItems.forEach((item, idx) => {
        prompt += `${idx + 1}. Заголовок: ${item.title || ''}\n   Текст: ${item.text || ''}\n`;
    });

    const config = getApiConfig(model);
    if (!config || !config.url) {
        console.error("Invalid API config for model:", model);
        showAIFallbackWarning(true);
        return newsItems.map(() => ({ sentiment: 'neutral', impact: 'low' }));
    }

    const headers = {
        "Authorization": `Bearer ${key}`,
        "Content-Type": "application/json"
    };
    if (config.url.includes('openrouter')) {
        headers["HTTP-Referer"] = APP_URL || window.location.origin;
        headers["X-Title"] = APP_NAME || "AI Terminal";
    }

    for (let k in headers) {
        headers[k] = String(headers[k]);
    }

    try {
        const response = await fetch(config.url, {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
                model: config.modelName,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.1,
                stream: false
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        const content = data.choices[0].message.content;

        // --- УЛУЧШЕННЫЙ ПАРСИНГ ---
        let results = null;
        
        // 1. Очищаем от возможных markdown-тегов нейросети
        const cleanContent = content.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
        
        try {
            const parsed = JSON.parse(cleanContent);
            results = parsed.results || parsed;
        } catch (e) {
            // 2. Фолбэк: пробуем вытащить массив с помощью регулярки
            const arrayMatch = cleanContent.match(/\[[\s\S]*\]/);
            if (arrayMatch) {
                try {
                    results = JSON.parse(arrayMatch[0]);
                } catch (e2) {}
            }
        }

        // Убрана строгая проверка длины массива. Берем то, что отдала модель.
        if (results && Array.isArray(results)) {
            hideAIFallbackWarning();
            // Возвращаем результаты, подставляя нейтральные, если модель вернула меньше элементов
            return newsItems.map((_, idx) => {
                const r = results[idx];
                return {
                    sentiment: r?.sentiment || 'neutral',
                    impact: r?.impact || 'low'
                };
            });
        } else {
            throw new Error("Не удалось извлечь JSON из ответа: " + content.substring(0, 100));
        }
    } catch (e) {
        console.error("Сбой AI классификации:", e.message);
        showAIFallbackWarning(true);
        return newsItems.map(() => ({ sentiment: 'neutral', impact: 'low' }));
    }
}
