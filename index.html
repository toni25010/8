<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; --buy: #238636; --sell: #f85149; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
        h2 { text-align: center; font-size: clamp(1.1rem, 4vw, 1.6rem); margin: 0 0 12px 0; }
        .grid { display: grid; grid-template-columns: 2.2fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        #chart { height: 400px; width: 100%; position: relative; background: var(--card); border-radius: 12px; overflow: hidden; }
        
        .ticker-wrap { display: flex; justify-content: space-between; background: #0d1117; padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ticker-val { font-size: 24px; font-weight: 700; font-family: 'Courier New'; }
        .ticker-label { font-size: 10px; color: #8b949e; margin-bottom: 2px; }
        
        .signal-display { text-align: center; padding: 12px; border-radius: 16px; border: 2px solid var(--border); margin-bottom: 12px; transition: 0.3s; }
        .signal-display.buy { border-color: var(--buy); color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .signal-display.sell { border-color: var(--sell); color: var(--sell); background: rgba(248, 81, 73, 0.1); }
        .signal-display.hold { border-color: #d29922; color: #d29922; background: rgba(210, 153, 34, 0.1); }
        
        .trade-plan-box { margin-top: 10px; background: #0d1117; border-radius: 12px; padding: 10px; border: 1px solid var(--border); display: none; }
        .plan-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .plan-row:last-child { border-bottom: none; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        .news-box { margin-top: 12px; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .news-item { padding: 8px; border-left: 4px solid #3b82f6; margin-bottom: 6px; background: rgba(255,255,255,0.02); position: relative; }
        .news-time { color: #60a5fa; font-size: 10px; font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; }
        .news-text { color: var(--text); }
        .news-sentiment { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 600; margin-top: 4px; }
        .sentiment-bullish { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .sentiment-bearish { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .sentiment-neutral { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .impact-badge { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .impact-high { background: #f85149; }
        .impact-medium { background: #d29922; }
        .impact-low { background: #3b82f6; }
        .news-filter { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .filter-btn { background: #21262d; color: var(--text); border: 1px solid var(--border); padding: 4px 8px; border-radius: 12px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .filter-btn:hover { opacity: 0.8; }
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .news-header span { color: #8b949e; font-size: 11px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-item { background: #0d1117; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); }
        
        button { background: var(--accent); color: white; border: none; padding: 12px 16px; cursor: pointer; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.small { background: #21262d; width: auto; padding: 8px 12px; margin-top: 0; font-size: 12px; }
        
        input { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 10px; margin-top: 6px; font-size: 14px; }
        select { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 10px; margin-top: 6px; font-size: 14px; cursor: pointer; }
        
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--border); z-index: 100; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--sell); font-size: 12px; text-align: center; margin-top: 10px; }

        .ticker-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .ticker-input {
            flex: 2 1 150px;
            min-width: 120px;
        }
        .ticker-btn {
            flex: 0 1 auto;
            background: #21262d;
            color: white;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .ticker-btn:hover {
            background: #2d333b;
        }

        .instrument-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }

        .analysis-summary {
            margin-top: 12px;
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #161b22;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
        }
        .summary-header:hover {
            background: #1f242c;
        }
        #ai_desc {
            padding: 10px;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text);
            border-top: 1px solid var(--border);
            white-space: pre-wrap;
        }

        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h2>AI Terminal | –ú—É–ª—å—Ç–∏–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>

    <div class="grid">
        <!-- LEFT -->
        <div class="card">
            <div class="ticker-controls">
                <input type="text" id="tickerInput" class="ticker-input" placeholder="–ö–æ–¥ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä SiH6" value="SiH6">
                <button class="ticker-btn" onclick="setTicker('SiH6')">Si</button>
                <button class="ticker-btn" onclick="setTicker('SRH6')">SBER</button>
                <button class="ticker-btn" onclick="setTicker('BRH6')">BR</button>
                <button class="ticker-btn" onclick="applyTicker()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>

            <div id="chart"><div id="loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 6px; padding: 0 4px; font-size: 11px; color: #8b949e;">
                <span id="contractName">–ö–æ–Ω—Ç—Ä–∞–∫—Ç: <span id="tickerDisplay">SiH6</span></span>
                <span id="lastTradeTime">--</span>
            </div>

            <!-- –ù–û–í–û–°–¢–ù–û–ô –ë–õ–û–ö -->
            <div class="news-box" id="newsBox">
                <div class="news-header">
                    <span style="font-weight: 600; color: #3b82f6;">–ù–æ–≤–æ—Å—Ç–∏ <span id="instrumentNewsLabel">–¥–ª—è Si</span></span>
                    <span id="newsCount">0</span>
                </div>
                <div class="news-filter">
                    <button class="filter-btn active" onclick="filterNews('all', event)">–í—Å–µ</button>
                    <button class="filter-btn" onclick="filterNews('bullish', event)">–ë—ã—á—å–∏</button>
                    <button class="filter-btn" onclick="filterNews('bearish', event)">–ú–µ–¥–≤–µ–∂—å–∏</button>
                    <button class="filter-btn" onclick="refreshNews()">üîÑ</button>
                </div>
                <div id="newsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
            <div class="ticker-wrap">
                <div style="text-align: left;">
                    <div class="ticker-label">–ü–û–°–õ–ï–î–ù–Ø–Ø –¶–ï–ù–ê</div>
                    <div class="ticker-val" id="currentPrice">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="ticker-label">–ò–ó–ú–ï–ù–ï–ù–ò–ï</div>
                    <div class="ticker-val" id="changePercent">--</div>
                </div>
            </div>

            <div id="signal_ui" class="signal-display hold">
                <div style="font-size: 10px; opacity: 0.7;">–°–ò–ì–ù–ê–õ</div>
                <div id="signal_text" style="font-size: 24px; font-weight: bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
                <div id="signal_confidence" style="font-size: 11px; margin-top: 2px;"></div>
            </div>

            <div id="tradePlanBox" class="trade-plan-box">
                <div style="text-align: center; font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">–¢–û–†–ì–û–í–´–ô –ü–õ–ê–ù</div>
                <div class="plan-row"><span><span class="dot" style="background: #58a6ff;"></span>Entry</span><span id="aiEntry" style="color: #58a6ff">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--buy);"></span>TP</span><span id="aiTP" style="color: var(--buy)">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--sell);"></span>SL</span><span id="aiSL" style="color: var(--sell)">--</span></div>
            </div>

            <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π –±–ª–æ–∫ –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="analysis-summary">
                <div class="summary-header" onclick="toggleAnalysis()">
                    <span>–ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞–ª–∞</span>
                    <span id="toggleIcon">‚ñº</span>
                </div>
                <div id="ai_desc" class="summary-content" style="display: none;"></div>
            </div>

            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-item"><div style="color: #8b949e;">RSI</div><div id="statRsi">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">ATR</div><div id="statAtr">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">MACD</div><div id="statMacd">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">–¢—Ä–µ–Ω–¥</div><div id="statTrend">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">EMA50</div><div id="statEma50">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">EMA200</div><div id="statEma200">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">BB –≤–µ—Ä—Ö</div><div id="statBBupper">-</div></div>
                <div class="stat-item"><div style="color: #8b949e;">BB –Ω–∏–∂–Ω</div><div id="statBBlower">-</div></div>
            </div>

            <button onclick="runAnalysis()" type="button"> –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó</button>

            <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –∏ API –∫–ª—é—á–∞ -->
            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
                <label style="font-size: 11px;">–ú–æ–¥–µ–ª—å AI:</label>
                <select id="modelSelect">
                    <option value="deepseek/deepseek-v3.2" selected>DeepSeek V3.2 (via OpenRouter)</option>
                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                    <option value="minimax/minimax-01">Minimax M2.5</option>
                    <option value="moonshotai/kimi-v2.5">Kimi K2.5</option>
                    <option value="z-ai/glm-5">GLM 5</option>
                    <option value="deepseek-chat">DeepSeek-V3.2 Chat (official API)</option>
                    <option value="deepseek-reasoner">DeepSeek-V3.2 Reasoner (official API)</option>
                </select>

                <label style="font-size: 11px; margin-top: 8px; display: block;">API Key (OpenRouter –∏–ª–∏ DeepSeek):</label>
                <input type="password" id="api_key_input" placeholder="sk-or-... –∏–ª–∏ ds-..." value="">
                <button class="small" onclick="saveKey()" style="margin-top: 4px; width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <div style="font-size: 10px; color: #8b949e; margin-top: 5px;">–î–ª—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π DeepSeek –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª—é—á —Å platform.deepseek.com</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================
        const MOEX_BASE = "https://iss.moex.com/iss/engines/futures/markets/forts";
        
        let currentTicker = "SiH6";
        let currentInstrumentType = 'Si';
        let chart = null;
        let candleSeries = null;
        let priceLines = [];
        let historyData = [];
        let allNews = [];
        let currentNewsFilter = 'all';
        const currentTf = 60;

        let analysisState = {
            news: { score: 0, direction: 'neutral', items: [] }
        };

        const APP_NAME = "AI Terminal";
        const APP_URL = window.location.origin;

        let lastAnalysisTime = 0;
        let lastAnalysisPrice = 0;
        const MIN_PRICE_CHANGE_PERCENT = 0.2;
        const MIN_ANALYSIS_INTERVAL = 2 * 60 * 1000;

        let lastSignal = { signal: "–î–ï–†–ñ–ê–¢–¨", confidence: 0, entry: 0, tp: 0, sl: 0, reason: "" };

        // ==================== –§–£–ù–ö–¶–ò–ò –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –¢–ò–ü–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê ==================
        function getInstrumentType(ticker) {
            const upper = ticker.toUpperCase();
            if (upper.includes('SI')) return 'Si';
            if (upper.includes('SR') || upper.includes('SBER')) return 'SBER';
            if (upper.includes('BR')) return 'BR';
            return 'unknown';
        }

        function updateInstrumentLabel() {
            const label = document.getElementById('instrumentNewsLabel');
            if (label) label.innerText = `–¥–ª—è ${currentInstrumentType}`;
        }

        // ==================== 1. –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ò–ö–ï–†–û–ú ==================
        const antiCache = () => `_=${Date.now()}`;

        function setTicker(ticker) {
            currentTicker = ticker;
            currentInstrumentType = getInstrumentType(ticker);
            document.getElementById('tickerInput').value = ticker;
            document.getElementById('tickerDisplay').innerText = ticker;
            updateInstrumentLabel();

            fetchQuotes();
            fetchCandles();
            fetchNews();
        }

        function applyTicker() {
            const newTicker = document.getElementById('tickerInput').value.trim();
            if (newTicker) setTicker(newTicker);
        }

        // ==================== 2. –î–ê–ù–ù–´–ï MOEX ==================
        async function fetchQuotes() {
            if(!currentTicker) return;
            const url = `${MOEX_BASE}/securities/${currentTicker}.json?iss.only=marketdata&${antiCache()}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const cols = data.marketdata.columns;
                const row = data.marketdata.data[0];
                if(!row) {
                    document.getElementById('currentPrice').innerText = '--';
                    document.getElementById('changePercent').innerText = '--';
                    return;
                }
                
                const idx = { last: cols.indexOf('LAST'), chg: cols.indexOf('CHANGE'), time: cols.indexOf('SYSTIME'), prev: cols.indexOf('PREVPRICE') };
                
                const quote = {
                    price: row[idx.last],
                    change: row[idx.chg],
                    prev: row[idx.prev],
                    time: row[idx.time]
                };
                
                updatePriceUI(quote);
                if(quote.price) updateChartLive(quote.price);

            } catch(e) { console.error("Quote error", e); }
        }

        function parseMoexTime(dateStr) {
            const [datePart, timePart] = dateStr.split(' ');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hour, minute, second] = timePart.split(':').map(Number);
            return Math.floor(Date.UTC(year, month-1, day, hour-3, minute, second) / 1000);
        }

        async function fetchCandles() {
            if(!currentTicker) return;
            console.log('Fetching candles at', new Date().toLocaleTimeString());
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'flex';
            
            const d = new Date();
            d.setDate(d.getDate() - 7);
            const from = d.toISOString().split('T')[0];
            
            const url = `${MOEX_BASE}/securities/${currentTicker}/candles.json?interval=${currentTf}&from=${from}&${antiCache()}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.candles?.data?.length) throw new Error("–ù–µ—Ç —Å–≤–µ—á–µ–π");

                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), t: cols.indexOf('begin') };

                historyData = data.candles.data.map(r => ({
                    time: parseMoexTime(r[idx.t]),
                    open: r[idx.o], high: r[idx.h], low: r[idx.l], close: r[idx.c]
                })).filter(c => c.close > 0);

                renderChart(historyData);
            } catch(e) {
                console.error('Error fetching candles:', e);
                if (loading) loading.innerHTML = `<span style='color:var(--sell); font-size:12px;'>–û—à–∏–±–∫–∞: ${e.message}</span>`;
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        // ==================== 3. –ù–û–í–û–°–¢–ò –ß–ï–†–ï–ó –°–û–ë–°–¢–í–ï–ù–ù–´–ô API ==================
        const RSS_FEEDS = [
            // –†–æ—Å—Å–∏–π—Å–∫–∏–µ
            'https://lenta.ru/rss/news',
            'https://www.vedomosti.ru/rss/articles',
            // –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ (–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã)
            'https://feeds.bbci.co.uk/news/business/rss.xml',
            'https://www.ft.com/rss/world',
            'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=1583903690',
            'https://feeds.a.dj.com/rss/WSJcomUSBusiness.xml'
        ];

        function getApiConfig(selectedModel) {
            if (selectedModel === 'deepseek-chat' || selectedModel === 'deepseek-reasoner') {
                return { url: 'https://api.deepseek.com/chat/completions', modelName: selectedModel };
            } else {
                return { url: 'https://openrouter.ai/api/v1/chat/completions', modelName: selectedModel };
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π —Å –≥–∏–±–∫–∏–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º
        async function classifyNewsBatch(newsItems, instrumentType) {
            const key = document.getElementById('api_key_input').value.trim();
            const model = document.getElementById('modelSelect').value;
            if (!key) {
                showAIFallbackWarning(true);
                return newsItems.map(() => ({ sentiment: 'neutral', impact: 'low' }));
            }
            if (newsItems.length === 0) return [];

            let instruction = '';
            if (instrumentType === 'Si') {
                instruction = `–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –≤–ª–∏—è–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ –∫—É—Ä—Å —Ä—É–±–ª—è (—Ñ—å—é—á–µ—Ä—Å Si). 
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ sentiment –∏ impact –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
- sentiment: "bullish" (—Ä—É–±–ª—å —Å–ª–∞–±–µ–µ—Ç ‚Üí –¥–æ–ª–ª–∞—Ä —Ä–∞—Å—Ç—ë—Ç) –µ—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞ –¥–ª—è –†–§ (—Å–∞–Ω–∫—Ü–∏–∏, –≤–æ–π–Ω–∞, –ø–∞–¥–µ–Ω–∏–µ –Ω–µ—Ñ—Ç–∏, –∫—Ä–∏–∑–∏—Å)
- sentiment: "bearish" (—Ä—É–±–ª—å —É–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è) –µ—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω–∞ –¥–ª—è –†–§ (—Ä–æ—Å—Ç –Ω–µ—Ñ—Ç–∏, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, —É—Å–ø–µ—Ö–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏)
- sentiment: "neutral" –µ—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è.
- impact: "high" (—Å–∏–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ), "medium" (—Å—Ä–µ–¥–Ω–µ–µ), "low" (—Å–ª–∞–±–æ–µ) ‚Äî –æ—Ü–µ–Ω–∏ –≤–∞–∂–Ω–æ—Å—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –≤–∞–ª—é—Ç–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞.`;
            } else if (instrumentType === 'SBER') {
                instruction = `–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –≤–ª–∏—è–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ –∞–∫—Ü–∏–∏ –°–±–µ—Ä–∞ (Sberbank).
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ sentiment –∏ impact.
- sentiment: "bullish" (–ø–æ–∑–∏—Ç–∏–≤–Ω–æ –¥–ª—è –∞–∫—Ü–∏–π), "bearish" (–Ω–µ–≥–∞—Ç–∏–≤–Ω–æ), "neutral".
- impact: "high", "medium", "low" ‚Äî –æ—Ü–µ–Ω–∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞.`;
            } else if (instrumentType === 'BR') {
                instruction = `–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –≤–ª–∏—è–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ —Ü–µ–Ω—É –Ω–µ—Ñ—Ç–∏ Brent.
–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ sentiment –∏ impact.
- sentiment: "bullish" (—Ä–æ—Å—Ç —Ü–µ–Ω), "bearish" (–ø–∞–¥–µ–Ω–∏–µ), "neutral".
- impact: "high", "medium", "low" ‚Äî –æ—Ü–µ–Ω–∏ –≤–∞–∂–Ω–æ—Å—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –Ω–µ—Ñ—Ç—è–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞.`;
            } else {
                instruction = `–î–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–∏ sentiment (bullish/bearish/neutral) –∏ impact (high/medium/low).`;
            }

            let prompt = instruction + "\n\n–í–µ—Ä–Ω–∏ JSON-–º–∞—Å—Å–∏–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{\"sentiment\": \"bullish\", \"impact\": \"high\"}, ...] –∏–ª–∏ –æ–±—ä–µ–∫—Ç {\"results\": [...]}. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.\n\n–ù–æ–≤–æ—Å—Ç–∏:\n";
            newsItems.forEach((item, idx) => {
                prompt += `${idx + 1}. –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${item.title || ''}\n   –¢–µ–∫—Å—Ç: ${item.text || ''}\n`;
            });

            const config = getApiConfig(model);
            const headers = {
                "Authorization": `Bearer ${key}`,
                "Content-Type": "application/json"
            };
            if (config.url.includes('openrouter')) {
                headers["HTTP-Referer"] = APP_URL;
                headers["X-Title"] = APP_NAME;
            }

            try {
                const response = await fetch(config.url, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify({
                        model: config.modelName,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1,
                        stream: false
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const content = data.choices[0].message.content;

                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON: —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º results, –ø–æ—Ç–æ–º –º–∞—Å—Å–∏–≤
                let results = null;
                // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º results
                const objectMatch = content.match(/\{[\s\S]*"results"[\s\S]*\}/);
                if (objectMatch) {
                    try {
                        const parsed = JSON.parse(objectMatch[0]);
                        if (parsed.results && Array.isArray(parsed.results) && parsed.results.length === newsItems.length) {
                            results = parsed.results;
                        }
                    } catch (e) { /* –Ω–µ —É–¥–∞–ª–æ—Å—å */ }
                }
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –æ–±—ä–µ–∫—Ç, –∏—â–µ–º –º–∞—Å—Å–∏–≤
                if (!results) {
                    const arrayMatch = content.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        const parsed = JSON.parse(arrayMatch[0]);
                        if (Array.isArray(parsed) && parsed.length === newsItems.length) {
                            results = parsed;
                        }
                    }
                }

                if (results) {
                    hideAIFallbackWarning();
                    return results;
                } else {
                    throw new Error("Invalid results array");
                }
            } catch (e) {
                console.error("AI classification failed, falling back to neutral/low", e);
                showAIFallbackWarning(true);
                return newsItems.map(() => ({ sentiment: 'neutral', impact: 'low' }));
            }
        }

        async function fetchFromRSS(rssUrl) {
            const news = [];
            const encodedUrl = encodeURIComponent(rssUrl);
            const apiUrl = `/api/rss?url=${encodedUrl}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.warn(`RSS fetch failed for ${rssUrl}: status ${response.status}`);
                    return news;
                }
                const data = await response.json();
                if (!data.items) {
                    console.warn(`Invalid RSS data from ${rssUrl}`);
                    return news;
                }

                for (const item of data.items) {
                    const pubDate = new Date(item.pubDate);
                    const title = item.title || '';
                    const description = item.description || '';

                    news.push({
                        id: Math.random().toString(36).substr(2, 9),
                        time: pubDate,
                        title: title.substring(0, 150),
                        text: description.replace(/<[^>]*>/g, '').substring(0, 200),
                        link: item.link
                    });
                }
            } catch (e) {
                console.warn(`Error fetching ${rssUrl}:`, e.message);
            }
            return news;
        }

        function generateFallbackNews() {
            const now = new Date();
            const templates = [
                { title: '–¶–ë –†–§: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏' },
                { title: '–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ –ú–ú–í–ë' },
                { title: '–¶–µ–Ω—ã –Ω–∞ –Ω–µ—Ñ—Ç—å Brent' }
            ];
            return templates.map((item, i) => ({
                id: i,
                time: new Date(now.getTime() - i * 3600000),
                title: item.title,
                text: '–î–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',
                sentiment: 'neutral',
                impact: 'low'
            }));
        }

        function showAIFallbackWarning(show) {
            let warning = document.getElementById('aiFallbackWarning');
            if (!warning) {
                warning = document.createElement('div');
                warning.id = 'aiFallbackWarning';
                warning.style.backgroundColor = '#f85149';
                warning.style.color = 'white';
                warning.style.padding = '4px 8px';
                warning.style.borderRadius = '4px';
                warning.style.fontSize = '11px';
                warning.style.marginBottom = '8px';
                warning.style.display = show ? 'block' : 'none';
                warning.innerText = '‚ö†Ô∏è AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ—Ç –∫–ª—é—á–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞). –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏.';
                const newsHeader = document.querySelector('.news-header');
                if (newsHeader) newsHeader.insertAdjacentElement('afterend', warning);
            } else {
                warning.style.display = show ? 'block' : 'none';
            }
        }

        function hideAIFallbackWarning() {
            showAIFallbackWarning(false);
        }

        async function fetchNews() {
            const container = document.getElementById('newsList');
            container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>';

            const allFetchedNews = [];
            for (const rssUrl of RSS_FEEDS) {
                const news = await fetchFromRSS(rssUrl);
                allFetchedNews.push(...news);
            }

            if (allFetchedNews.length === 0) {
                const news = generateFallbackNews();
                allNews = news;
                analysisState.news.items = news;
                renderNews(news);
                updateNewsScore(news);
                return;
            }

            allFetchedNews.sort((a, b) => b.time - a.time);
            const now = new Date();
            const filteredNews = allFetchedNews.filter(n => (now - n.time) / 3600000 <= 48);

            const results = await classifyNewsBatch(filteredNews, currentInstrumentType);
            filteredNews.forEach((item, idx) => {
                item.sentiment = results[idx]?.sentiment || 'neutral';
                item.impact = results[idx]?.impact || 'low';
            });

            allNews = filteredNews;
            analysisState.news.items = filteredNews;
            renderNews(filteredNews);
            updateNewsScore(filteredNews);
        }

        function updateNewsScore(news) {
            let bullishCount = 0, bearishCount = 0;
            news.forEach(item => {
                if (item.sentiment === 'bullish') bullishCount++;
                if (item.sentiment === 'bearish') bearishCount++;
            });
            const netScore = bullishCount - bearishCount;
            analysisState.news.score = netScore;
            analysisState.news.direction = netScore > 0 ? 'bullish' : netScore < 0 ? 'bearish' : 'neutral';
        }

        function renderNews(news) {
            const container = document.getElementById('newsList');
            document.getElementById('newsCount').textContent = news.length;
            if (!news.length) {
                container.innerHTML = '<div style="text-align: center; color: #8b949e; padding: 20px;">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
                return;
            }
            container.innerHTML = news.map(item => {
                const timeStr = item.time.toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
                const sentimentLabel = {
                    'bullish': 'üìà –ë—ã—á—å—è',
                    'bearish': 'üìâ –ú–µ–¥–≤–µ–∂—å—è',
                    'neutral': '‚û°Ô∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è'
                };
                const impactClass = {
                    'high': 'impact-high',
                    'medium': 'impact-medium',
                    'low': 'impact-low'
                };
                const impactText = {
                    'high': 'üî¥ –≤—ã—Å–æ–∫–æ–µ',
                    'medium': 'üü° —Å—Ä–µ–¥–Ω–µ–µ',
                    'low': 'üîµ –Ω–∏–∑–∫–æ–µ'
                };
                const borderColor = item.impact === 'high' ? '#f85149' : (item.impact === 'medium' ? '#d29922' : '#3b82f6');
                return `
                    <div class="news-item" style="border-left-color: ${borderColor};">
                        <div class="news-time">
                            <span class="impact-badge ${impactClass[item.impact]}" title="–í–ª–∏—è–Ω–∏–µ: ${item.impact}"></span>
                            ${timeStr}
                        </div>
                        <div class="news-text"><strong>${item.title}</strong></div>
                        <div class="news-text" style="font-size: 12px; color: #8b949e; margin-top: 4px;">${item.text}</div>
                        <span class="news-sentiment sentiment-${item.sentiment}">${sentimentLabel[item.sentiment]}</span>
                        <span style="margin-left: 8px; font-size: 9px; color: #8b949e;">${impactText[item.impact]}</span>
                    </div>
                `;
            }).join('');
        }

        function filterNews(type, event) {
            currentNewsFilter = type;
            document.querySelectorAll('#newsBox .filter-btn').forEach(btn => btn.classList.remove('active'));
            if (event?.target) event.target.classList.add('active');

            let filtered = allNews;
            if (type === 'bullish') filtered = allNews.filter(n => n.sentiment === 'bullish');
            else if (type === 'bearish') filtered = allNews.filter(n => n.sentiment === 'bearish');
            renderNews(filtered);
        }

        function refreshNews() { fetchNews(); }

        // ==================== 4. –†–ï–ê–õ–¢–ê–ô–ú –ì–†–ê–§–ò–ö ==================
        function updateChartLive(price) {
            if (!candleSeries || !historyData.length) return;
            const nowUtc = Math.floor(Date.now() / 1000);
            const mskOffset = 3 * 3600;
            const nowMsk = nowUtc + mskOffset;
            const tfSeconds = currentTf * 60;
            const startOfIntervalMsk = Math.floor(nowMsk / tfSeconds) * tfSeconds;
            const currentCandleTime = startOfIntervalMsk - mskOffset;

            let lastCandle = historyData[historyData.length - 1];
            if (lastCandle.time === currentCandleTime) {
                lastCandle.close = price;
                if (price > lastCandle.high) lastCandle.high = price;
                if (price < lastCandle.low) lastCandle.low = price;
            } else {
                historyData.push({ time: currentCandleTime, open: lastCandle.close, high: price, low: price, close: price });
                if (historyData.length > 500) historyData.shift();
            }
            candleSeries.update(historyData[historyData.length - 1]);
        }

        function renderChart(data) {
            const cont = document.getElementById('chart');
            const loading = document.getElementById('loading');
            cont.innerHTML = '';
            if (loading) { cont.appendChild(loading); loading.style.display = 'none'; }
            else {
                const newLoading = document.createElement('div');
                newLoading.id = 'loading';
                newLoading.innerHTML = '<div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...';
                newLoading.style.display = 'none';
                cont.appendChild(newLoading);
            }
            if (chart) { chart.remove(); chart = null; }
            priceLines = [];

            chart = LightweightCharts.createChart(cont, {
                layout: { background: { color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                timeScale: { timeVisible: true },
                width: cont.clientWidth, height: 400
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#f85149', borderVisible: false });
            candleSeries.setData(data);
            chart.timeScale().fitContent();
        }

        function drawPlan(e, tp, sl) {
            if(!candleSeries) return;
            priceLines.forEach(l => candleSeries.removePriceLine(l));
            priceLines = [];
            const mkLine = (p, c, t) => candleSeries.createPriceLine({ price: p, color: c, lineWidth: 2, lineStyle: 1, title: t });
            priceLines.push(mkLine(e, '#58a6ff', 'Entry'));
            priceLines.push(mkLine(tp, '#238636', 'TP'));
            priceLines.push(mkLine(sl, '#f85149', 'SL'));
        }

        function updatePriceUI(q) {
            if(!q?.price) return;
            document.getElementById('currentPrice').innerText = q.price.toFixed(2);
            if(q.prev > 0) {
                const pct = ((q.price - q.prev)/q.prev * 100);
                document.getElementById('changePercent').innerText = (pct>=0?'+':'') + pct.toFixed(2)+'%';
                document.getElementById('changePercent').style.color = pct>=0?'var(--buy)':'var(--sell)';
            }
            if(q.time) document.getElementById('lastTradeTime').innerText = "–°–¥–µ–ª–∫–∞: " + new Date(q.time).toLocaleTimeString('ru-RU');
        }

        // ==================== 7. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó ==================
        function calcTech() {
            if (historyData.length < 50) return null;
            const c = historyData.map(d => d.close);
            const closes = c;

            let g = 0, l = 0;
            for (let i = closes.length - 14; i < closes.length; i++) {
                const d = closes[i] - closes[i - 1];
                if (d > 0) g += d; else l -= d;
            }
            const rsi = l === 0 ? 100 : 100 - (100 / (1 + g / l));

            const ema = (p, per) => p.slice(1).reduce((e, v) => v * (2 / (per + 1)) + e * (1 - 2 / (per + 1)), p[0]);
            const macdLine = ema(closes, 12) - ema(closes, 26);

            let tr = 0;
            for (let i = historyData.length - 14; i < historyData.length; i++) {
                const h = historyData[i].high, l = historyData[i].low, pc = historyData[i - 1].close;
                tr += Math.max(h - l, Math.abs(h - pc), Math.abs(l - pc));
            }
            const atr = tr / 14;

            const ema50 = ema(closes.slice(-50), 50);
            const ema200 = ema(closes, 200);

            const periodBB = 20;
            const bbCloses = closes.slice(-periodBB);
            const mean = bbCloses.reduce((a, b) => a + b, 0) / periodBB;
            const stdDev = Math.sqrt(bbCloses.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / periodBB);
            const upperBB = mean + 2 * stdDev;
            const lowerBB = mean - 2 * stdDev;

            const priceChange3 = (closes[closes.length - 1] - closes[closes.length - 4]) / closes[closes.length - 4] * 100;
            const macdPrev = ema(closes.slice(0, -1), 12) - ema(closes.slice(0, -1), 26);
            const macdChange = macdLine - macdPrev;

            const lastPrice = closes[closes.length - 1];
            const trend = lastPrice > ema50 ? (lastPrice > ema200 ? 'STRONG_BULL' : 'BULL') : (lastPrice < ema200 ? 'STRONG_BEAR' : 'BEAR');

            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('statRsi').innerText = rsi.toFixed(1);
            document.getElementById('statAtr').innerText = atr.toFixed(2);
            document.getElementById('statMacd').innerText = macdLine.toFixed(2);
            document.getElementById('statMacd').style.color = macdLine > 0 ? 'var(--buy)' : 'var(--sell)';
            document.getElementById('statTrend').innerText = trend;
            document.getElementById('statEma50').innerText = ema50.toFixed(2);
            document.getElementById('statEma200').innerText = ema200.toFixed(2);
            document.getElementById('statBBupper').innerText = upperBB.toFixed(2);
            document.getElementById('statBBlower').innerText = lowerBB.toFixed(2);

            return {
                rsi, atr, macd: macdLine, price: lastPrice, trend,
                ema50, ema200, upperBB, lowerBB, priceChange3, macdChange
            };
        }

        // ==================== 8. –û–°–ù–û–í–ù–û–ô –ê–ù–ê–õ–ò–ó (AI) ==================
        async function runAnalysis() {
            const key = document.getElementById('api_key_input').value.trim();
            const model = document.getElementById('modelSelect').value;
            if(!key) { console.log("–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø—É—â–µ–Ω: –Ω–µ—Ç API –∫–ª—é—á–∞"); return; }
            
            const tech = calcTech();
            if (!tech) { console.log("–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø—É—â–µ–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö"); return; }

            lastAnalysisTime = Date.now();
            lastAnalysisPrice = tech.price;

            document.getElementById('signal_text').innerText = "–ê–ù–ê–õ–ò–ó...";
            document.getElementById('tradePlanBox').style.display = 'none';
            document.getElementById('ai_desc').style.display = 'none';

            let newsContext = "–ù–û–í–û–°–¢–ù–û–ô –§–û–ù:\n";
            if (allNews.length) {
                allNews.forEach((n, i) => newsContext += `${i+1}. ${n.title} (${n.sentiment === 'bullish' ? '–±—ã—á—å—è' : n.sentiment === 'bearish' ? '–º–µ–¥–≤–µ–∂—å—è' : '–Ω–µ–π—Ç—Ä.'}, –≤–ª–∏—è–Ω–∏–µ: ${n.impact})\n`);
            } else newsContext += "–ù–µ—Ç —Å–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.\n";

            const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ ${currentInstrumentType}. 
–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ö–ê–†–¢–ò–ù–ê:
- –¶–µ–Ω–∞: ${tech.price.toFixed(2)}
- RSI (14): ${tech.rsi.toFixed(1)} ${tech.rsi > 70 ? '(–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å)' : tech.rsi < 30 ? '(–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å)' : ''}
- MACD: ${tech.macd.toFixed(2)} ${tech.macd > 0 ? '(–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π)' : '(–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π)'}
- ATR (14): ${tech.atr.toFixed(2)} (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
- EMA50: ${tech.ema50.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.ema50 ? '–≤—ã—à–µ' : '–Ω–∏–∂–µ'} EMA50)
- EMA200: ${tech.ema200.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.ema200 ? '–≤—ã—à–µ' : '–Ω–∏–∂–µ'} EMA200)
- –ü–æ–ª–æ—Å—ã –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞ (20,2): –≤–µ—Ä—Ö–Ω—è—è ${tech.upperBB.toFixed(2)}, –Ω–∏–∂–Ω—è—è ${tech.lowerBB.toFixed(2)} (—Ü–µ–Ω–∞ ${tech.price > tech.upperBB ? '–≤—ã—à–µ –≤–µ—Ä—Ö–Ω–µ–π' : tech.price < tech.lowerBB ? '–Ω–∏–∂–µ –Ω–∏–∂–Ω–µ–π' : '–≤–Ω—É—Ç—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞'})
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–≤–µ—á–∏: ${tech.priceChange3.toFixed(2)}%
- –î–∏–Ω–∞–º–∏–∫–∞ MACD: ${tech.macdChange > 0 ? '—Ä–∞—Å—Ç—ë—Ç' : '–ø–∞–¥–∞–µ—Ç'}

${newsContext}

–û–±—â–∏–π –Ω–æ–≤–æ—Å—Ç–Ω–æ–π —Å—á—ë—Ç: ${analysisState.news.score} (${analysisState.news.direction})

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∏ –¥–∞–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª: –ü–û–ö–£–ü–ö–ê, –ü–†–û–î–ê–ñ–ê –∏–ª–∏ –î–ï–†–ñ–ê–¢–¨.
–£—á–∏—Ç—ã–≤–∞–π:
- –ï—Å–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É –∏–ª–∏ –Ω–æ–≤–æ—Å—Ç–Ω–æ–º—É —Ñ–æ–Ω—É, –æ—Ç–¥–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –±–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ–º—É —Å–∏–≥–Ω–∞–ª—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –î–ï–†–ñ–ê–¢–¨.
- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (confidence –æ—Ç 0 –¥–æ 100) –¥–æ–ª–∂–Ω–∞ –æ—Ç—Ä–∞–∂–∞—Ç—å —Ç–≤–æ—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–∏–≥–Ω–∞–ª–µ.
- –†–∞—Å—Å—á–∏—Ç–∞–π —É—Ä–æ–≤–Ω–∏ –≤—Ö–æ–¥–∞, —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞ –∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ ATR:
  * –î–ª—è –ü–û–ö–£–ü–ö–ê: entry = —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞, tp = entry + 1.5*ATR, sl = entry - 1*ATR.
  * –î–ª—è –ü–†–û–î–ê–ñ–ê: entry = —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞, tp = entry - 1.5*ATR, sl = entry + 1*ATR.
- –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –î–ï–†–ñ–ê–¢–¨, entry/tp/sl –æ—Å—Ç–∞–≤—å 0.

–í –ø–æ–ª–µ "reason" –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (–¥–æ 150 —Å–∏–º–≤–æ–ª–æ–≤), –∞ –∑–∞—Ç–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è —Å–µ–π—á–∞—Å —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä—ã–Ω–æ–∫, –¥–æ–±–∞–≤—å –ø–æ—Å–ª–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫—É —Å —Ç—Ä–µ–º—è –¥–µ—Ñ–∏—Å–∞–º–∏ "---" –∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "---\n–°–∞–º—ã–π –∑–Ω–∞—á–∏–º—ã–π —Ñ–∞–∫—Ç–æ—Ä: [–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏]"). –ï—Å–ª–∏ —Ç–∞–∫–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ—Ç, –ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ.

–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{ "signal": "–ü–û–ö–£–ü–ö–ê/–ü–†–û–î–ê–ñ–ê/–î–ï–†–ñ–ê–¢–¨", "confidence": 85, "entry": 0, "tp": 0, "sl": 0, "reason": "—Ç–µ–∫—Å—Ç —Å --- –∏ –Ω–æ–≤–æ—Å—Ç—å—é" }`;

            const config = getApiConfig(model);
            const headers = {
                "Authorization": `Bearer ${key}`,
                "Content-Type": "application/json"
            };
            if (config.url.includes('openrouter')) {
                headers["HTTP-Referer"] = APP_URL;
                headers["X-Title"] = APP_NAME;
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                const res = await fetch(config.url, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify({
                        model: config.modelName,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1,
                        stream: false
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                
                const json = parse(data.choices[0].message.content);
                console.log('–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª:', json);
                if (shouldUpdateUI(json, tech.price)) {
                    playAlertSound();
                    updateUI(json, tech.price);
                } else {
                    console.log('–°–∏–≥–Ω–∞–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, UI –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    restorePreviousSignal();
                }
            } catch (e) {
                clearTimeout(timeoutId);
                console.error("–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:", e);
                let errorMessage = e.message;
                if (e.name === 'AbortError') {
                    errorMessage = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI (15 —Å–µ–∫)';
                }
                document.getElementById('signal_text').innerText = "–û–®–ò–ë–ö–ê";
                document.getElementById('ai_desc').innerText = errorMessage;
                document.getElementById('ai_desc').style.display = 'block';
                restorePreviousSignal();
            }
        }

        function parse(s) {
            try {
                return JSON.parse(s.match(/\{[\s\S]*\}/)[0]);
            } catch {
                return { signal: "–î–ï–†–ñ–ê–¢–¨", confidence: 0, reason: "err", entry: 0, tp: 0, sl: 0 };
            }
        }

        function shouldUpdateUI(newSignal, currentPrice) {
            if (newSignal.signal !== lastSignal.signal) return true;
            if (Math.abs(newSignal.confidence - lastSignal.confidence) > 20) return true;
            return false;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—É–∫–∞ —á–µ—Ä–µ–∑ Web Audio API
        function playAlertSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.value = 523.25; // –Ω–æ—Ç–∞ –î–æ
                gainNode.gain.value = 0.1;

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2); // 200 –º—Å

                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±—ã–ª suspended, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–∞:", e);
            }
        }

        function restorePreviousSignal() {
            if (lastSignal && lastSignal.signal) {
                const ui = document.getElementById('signal_ui');
                ui.className = "signal-display " + (lastSignal.signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : lastSignal.signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold');
                document.getElementById('signal_text').innerText = lastSignal.signal;
                document.getElementById('signal_confidence').innerText = `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${lastSignal.confidence}%`;
                document.getElementById('ai_desc').innerText = lastSignal.reason;
                document.getElementById('ai_desc').style.display = 'block';
                if (lastSignal.entry && lastSignal.tp && lastSignal.sl && !isNaN(lastSignal.entry)) {
                    document.getElementById('tradePlanBox').style.display = 'block';
                    document.getElementById('aiEntry').innerText = lastSignal.entry.toFixed(2);
                    document.getElementById('aiTP').innerText = lastSignal.tp.toFixed(2);
                    document.getElementById('aiSL').innerText = lastSignal.sl.toFixed(2);
                    drawPlan(lastSignal.entry, lastSignal.tp, lastSignal.sl);
                } else {
                    document.getElementById('tradePlanBox').style.display = 'none';
                }
            } else {
                document.getElementById('signal_text').innerText = "–û–ñ–ò–î–ê–ù–ò–ï";
                document.getElementById('signal_confidence').innerText = '';
                document.getElementById('ai_desc').style.display = 'none';
                document.getElementById('tradePlanBox').style.display = 'none';
            }
        }

        function updateUI(j, p) {
            lastSignal = { ...j };

            const ui = document.getElementById('signal_ui');
            ui.className = "signal-display " + (j.signal === '–ü–û–ö–£–ü–ö–ê' ? 'buy' : j.signal === '–ü–†–û–î–ê–ñ–ê' ? 'sell' : 'hold');
            document.getElementById('signal_text').innerText = j.signal;
            document.getElementById('signal_confidence').innerText = `–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${j.confidence}%`;
            document.getElementById('ai_desc').innerText = j.reason;
            document.getElementById('ai_desc').style.display = 'block';
            if (j.entry && j.tp && j.sl && !isNaN(j.entry)) {
                document.getElementById('tradePlanBox').style.display = 'block';
                document.getElementById('aiEntry').innerText = j.entry.toFixed(2);
                document.getElementById('aiTP').innerText = j.tp.toFixed(2);
                document.getElementById('aiSL').innerText = j.sl.toFixed(2);
                drawPlan(j.entry, j.tp, j.sl);
            } else {
                document.getElementById('tradePlanBox').style.display = 'none';
            }
        }

        function toggleAnalysis() {
            const content = document.getElementById('ai_desc');
            const icon = document.getElementById('toggleIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.innerText = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.innerText = '‚ñ∂';
            }
        }

        // ==================== 9. –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –û–ë–ù–û–í–õ–ï–ù–ò–ô ==================
        function scheduleNextCandleUpdate() {
            const now = new Date();
            const target = new Date(now);
            target.setMinutes(16, 0, 0);
            if (target <= now) target.setHours(target.getHours() + 1);
            const delay = target - now;
            console.log(`Next candle update scheduled at ${target.toLocaleTimeString()} (in ${Math.round(delay/1000)} seconds)`);
            setTimeout(async () => { await fetchCandles(); scheduleNextCandleUpdate(); }, delay);
        }

        // ==================== 10. –ê–í–¢–û–ê–ù–ê–õ–ò–ó ==================
        let autoAnalysisInterval = null;
        function startAutoAnalysis() {
            if (autoAnalysisInterval) clearInterval(autoAnalysisInterval);
            autoAnalysisInterval = setInterval(() => {
                const key = document.getElementById('api_key_input').value.trim();
                if (!key) {
                    console.log('Auto analysis skipped: no API key');
                    return;
                }

                const currentPrice = parseFloat(document.getElementById('currentPrice').innerText);
                if (isNaN(currentPrice) || currentPrice === 0) {
                    console.log('Auto analysis skipped: invalid price');
                    return;
                }

                const now = Date.now();
                // –ó–∞—â–∏—Ç–∞ –æ—Ç Infinity –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
                if (lastAnalysisPrice === 0) {
                    lastAnalysisPrice = currentPrice;
                }
                const priceChangePercent = Math.abs((currentPrice - lastAnalysisPrice) / lastAnalysisPrice * 100);
                const timeSinceLastAnalysis = now - lastAnalysisTime;

                if (priceChangePercent >= MIN_PRICE_CHANGE_PERCENT || timeSinceLastAnalysis > 10 * 60 * 1000) {
                    console.log('Running auto analysis at', new Date().toLocaleTimeString(), `(price change: ${priceChangePercent.toFixed(2)}%)`);
                    runAnalysis();
                } else {
                    console.log('Auto analysis skipped: price change too small', priceChangePercent.toFixed(2), '%');
                }
            }, 60000);
        }

        // ==================== INIT ==================
        function saveKey() { localStorage.setItem('si_k', document.getElementById('api_key_input').value); alert("OK"); }

        window.onload = async () => {
            const k = localStorage.getItem('si_k');
            if (k) document.getElementById('api_key_input').value = k;

            const initialTicker = document.getElementById('tickerInput').value;
            setTicker(initialTicker);

            await Promise.all([fetchQuotes(), fetchCandles(), fetchNews()]);

            setInterval(fetchQuotes, 2000);
            setInterval(fetchNews, 600000);

            scheduleNextCandleUpdate();
            startAutoAnalysis();
        };
    </script>
</body>
</html>
